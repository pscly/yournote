## [2026-01-25 11:21] - 任务：补齐 Docker 部署（前端+后端）
- 原始需求：为项目补齐 Dockerfile + docker-compose；不要引入 PostgreSQL 镜像；让服务器在远端可直接 `docker compose` 部署与更新。
- 实现目标/逻辑：
  - 后端：基于 Python 3.13 + `uv.lock` 构建镜像，使用 `uv sync` 安装依赖；运行 `python backend/run.py`（生产默认关闭 reload）。
  - 前端：Vite 构建产物用 Nginx 提供静态服务，并在 Nginx 侧把 `/api`、`/docs` 等转发到后端容器，保证浏览器同源访问（前端默认 `API_BASE_URL=/api`）。
  - 数据持久化：SQLite DB 与访问日志目录通过 volume 绑定到宿主机（`./data`、`./logs`），更新镜像不丢数据。
- 核心变更：新增 `docker-compose.yml`、`backend/Dockerfile`、`frontend/Dockerfile`、`frontend/nginx.conf`、`.dockerignore` 等部署相关文件。
- 遗留/约束：
  - 不包含 PostgreSQL 镜像；如需切换到远程 PG，仅通过 `.env`/环境变量配置 `DATABASE_URL`。
  - 服务器更新流程：`git pull` 后执行 `docker compose up -d --build`（或 `docker-compose up -d --build`）。

## [2026-01-26 09:45] - 任务：新增部署与CI技能（docker-compose + GitLab CI/CD）
- 原始需求：你现在开发个 skill ，关于 docker-compose 部署相关，和gitlab cicd 相关(基于这个项目的架构，你开发一下呢)
- 实现目标/逻辑：
  - 基于当前仓库既有部署文件（`docker-compose.yml`、`backend/Dockerfile`、`frontend/Dockerfile`、`frontend/nginx.conf`、`.gitlab-ci.yml`）提炼可复用流程与检查清单。
  - Skill 面向 Codex：在用户提出“容器化部署 / docker compose / 自动发布 / GitLab Runner”等需求时，指导按最小改动落地，并保持数据持久化与 `.env` 不被流水线覆盖。
- 核心变更：新增 `.codex/skills/yournote-docker-gitlab/SKILL.md`、`.codex/skills/yournote-docker-gitlab/references/compose.md`、`.codex/skills/yournote-docker-gitlab/references/gitlab-ci.md`。
- 遗留/约束：
  - 不自动执行 `git commit`（除非用户明确要求）。
  - 延续约束：不引入 PostgreSQL 容器；默认 SQLite + volume 持久化，切换 PG 仅通过 `DATABASE_URL` 外部接入。

## [2026-01-26 09:58] - 任务：将部署与CI Skill 全局化并完善
- 原始需求：你现在把这个skill 开发成全局的，记得修改的非常完善和非常完美，
- 实现目标/逻辑：
  - 完善 `yournote-docker-gitlab` 的触发描述、工作流、排障与运维安全清单，使其不仅适配本仓库，也能作为类似架构项目的通用范式。
  - 将 Skill 安装到全局目录 `C:/Users/pscly/.codex/skills/`，使其在任意项目中可用（仓库内版本作为“源代码/开发版本”保留）。
- 核心变更：
  - 完善 Skill：更新 `.codex/skills/yournote-docker-gitlab/SKILL.md`、补充与增强 `references/*`（新增 `ops-security.md`、`troubleshooting.md`、`templates.md`）。
  - 全局安装：已同步复制到 `C:/Users/pscly/.codex/skills/yournote-docker-gitlab/`。
- 遗留/约束：
  - 全局安装需要写入用户目录（可能触发权限确认）。
  - 仍保持 CI 不覆盖服务器 `.env`、compose 持久化 `./data` 与 `./logs` 的原则。

## [2026-01-26 14:31] - 任务：倾向采用 SSH 远端部署方案（GitLab CI）
- 原始需求：那我感觉 SSH 方案会更好一些的感觉
- 实现目标/逻辑：
  - 采用“Runner 不在目标服务器”的发布模型：CI 通过 `rsync` 同步代码到服务器 `DEPLOY_DIR`，再通过 `ssh` 在服务器上执行 `docker compose up -d --build --remove-orphans`。
  - 继续遵循：CI 不覆盖服务器 `.env`；同步时排除 `data/`、`logs/` 保留持久化数据。
- 核心变更：待办把 `.gitlab-ci.yml` 调整为 SSH 部署 Job，并要求在 GitLab CI Variables 配置 `DEPLOY_HOST/DEPLOY_USER/DEPLOY_DIR/DEPLOY_PORT/DEPLOY_SSH_PRIVATE_KEY` 等。
- 遗留/约束：需确认目标服务器已安装 Docker + Compose v2、以及 deploy 用户执行 docker 的权限策略（docker group 或受限 sudo）。

## [2026-01-26 15:23] - 任务：主页账号列表默认收起
- 原始需求：把主页的「账号列表」改成默认就是收起的，然后自动提交并推送到 Git（GitHub+GitLab）。
- 实现目标/逻辑：
  - 将账号列表的默认折叠状态改为“默认收起”，且保留用户手动展开/收起并记忆的能力。
  - 为避免旧版本本地存储的历史偏好影响新默认值，对 localStorage key 进行 v2 版本化。
- 核心变更：更新 rontend/src/pages/Dashboard.jsx（默认折叠逻辑与存储 key）。
- 遗留/约束：无。

## [2026-01-27 17:25] - 任务：前端文案统一（日记->记录）
- 原始需求：你现在把前端里面所有日记两个字 都换成记录，然后提交推送。
- 实现目标/逻辑：
  - 仅在 frontend 目录内做全文字面替换，把所有中文"日记"统一改为"记录"。
- 核心变更：批量更新 frontend 下相关页面/测试/README/HTML 文案。
- 遗留/约束：无。

## [2026-01-27 17:50] - 任务：全仓库“体检 + 代码质量/安全/可维护性”优化
- 原始需求：你看看各个地方，是否有需要好好详细优化一下的地方呢？你把需要好好优化的地方都好好优化和完整完善一下呢?
- 实现目标/逻辑：
  - 先做全仓库体检，优先处理高风险/高收益问题（安全信息泄露、吞异常、可观测性差、版本信息不一致、脚本健壮性等）。
  - 后端优先：统一版本来源；API 层 5xx 错误不回显内部异常；访问日志错误信息脱敏且不影响业务。
  - 前端与脚本：在不改变现有业务行为的前提下，提升稳定性与可维护性（API 客户端/错误提示/一键脚本默认值与输出信息）。
  - 变更保持“最小必要”，避免引入大范围重构；涉及删除/移动本地文件（如测试账号/临时数据）将先征询用户确认。
- 核心变更：
  - 后端：新增 `backend/app/utils/errors.py`（异常信息脱敏/截断工具）；更新 `backend/app/main.py`（统一版本来源、访问日志错误脱敏且可观测、/health 增加 DB 探测）；更新 API 端点 `backend/app/api/accounts.py`、`backend/app/api/diaries.py`、`backend/app/api/sync.py`、`backend/app/api/publish_diary.py`（5xx 不回显内部异常、落库错误信息截断、补充关键异常日志）。
  - 前端：更新 `frontend/src/config.js`（API_BASE_URL 归一化：空值回退、去尾斜杠）；更新 `frontend/src/components/SyncMonitor.jsx`（补齐 hooks 依赖，lint 0 warning）。
  - 脚本：更新 `run.bat`（端口默认值 + 输出更清晰）、`stop.bat`（文案修正）。
- 遗留/约束：
  - 全仓库文件编码保持 UTF-8（无 BOM）；Windows/pwsh7 环境。
  - MCP 工具如不可用则降级为本地命令与人工审查（本次出现过 MCP Transport 关闭的情况）。

## [2026-02-04 23:03] - 任务：仪表盘新增配对记录按入库时间统计
- 原始需求：主页“配对记录数”的“今天新增”不应只按记录日期判断；需要按数据库对比统计，包含“今天才解锁的以前记录”也算新增；并要求改好后直接提交并 push。
- 实现目标/逻辑：
  - 后端新增接口按 `diaries.created_at`（首次入库时间）统计窗口内“新增配对记录”，并返回明细 + 作者信息，避免前端只拉前 N 条导致漏算。
  - 前端仪表盘新增“统计起点”切换（昨日 20:00 / 今日 00:00，北京时间），切换后只刷新新增统计，不触发全页加载；统计范围包含停用账号（按你的选择）。
- 核心变更：
  - 后端：扩展 `DiaryResponse` 暴露 `created_at/updated_at`；新增 `/stats/paired-diaries/increase` 端点与响应模型。
  - 前端：`Dashboard` 的“新增配对记录”从“按记录日期过滤”改为调用后端统计接口；新增统计起点 Segmented 切换并持久化 localStorage。
- 遗留/约束：
  - 若后续数据量显著增大，建议为 `diaries.created_at` 增加索引以进一步降低统计查询耗时（本次优先保持最小变更，先保证口径正确）。

## [2026-02-04 23:50] - 任务：记录图片缓存（解析 `[图13]` 并保存到本地 DB）
- 原始需求：nideriji 的图片接口在浏览器里会显示为 `blob:`（不可直接复用 URL）；希望后端读取记录后把图片保存下来（小图片，存 DB 即可），前端查看记录时能直接访问本项目的图片地址并展示附件。
- 实现目标/逻辑：
  - 后端：新增图片缓存表 `cached_images`（SQLite=BLOB / Postgres=BYTEA），按 `(nideriji_userid, image_id)` 唯一定位；提供图片接口 `GET /api/diaries/{diary_id}/images/{image_id}`，优先读本地缓存，不存在则用账号 `auth_token` 从上游 `f.nideriji.cn` 拉取并缓存。
  - 附件信息：`GET /api/diaries/{diary_id}` 返回 `attachments.images`，把正文里的 `[图13]` 映射成稳定 URL，供前端原位渲染。
  - 缓存策略：同步完成后后台“尽量预拉取”本次新增/更新且正文含图片占位符的记录；若仍缺失则图片接口兜底懒加载。
  - 可控性：新增图片缓存相关配置（开关、超时、最大大小、单次预拉取上限、上游 base url）。
- 核心变更：
  - 后端：新增 `backend/app/models/cached_image.py`；新增 `backend/app/services/image_cache.py`；扩展 `backend/app/api/diaries.py`（详情返回 attachments + 新增图片路由）；扩展 `backend/app/services/collector.py`（同步成功后后台预拉取图片）。
  - 前端：更新 `frontend/src/pages/DiaryDetail.jsx`，将正文中的 `[图N]` 原位替换为图片，并增加“附件（图片）”区用于预览。
  - 配置：更新 `.env.example`，补充图片缓存相关环境变量示例。
- 遗留/约束：
  - 图片接口依赖访问门禁 Cookie（同源部署最稳）；若跨域部署需确保 Cookie 的 SameSite/Secure 配置与 CORS 策略匹配。
  - 当前预拉取为“尽力而为”策略：失败（403/404/网络）仅落库状态，不影响同步成功。

## [2026-02-05 11:20] - 任务：新增配对记录历史页（按天）+ 详情页附件底部汇总
- 原始需求：
  - 在“新增配对记录”页面/入口里能看到历史新增记录（昨天、前天、某天）。
  - 每篇记录阅读页面末尾展示该记录的所有附件，并明确标注每张图片的图号（图几）。
- 实现目标/逻辑：
  - 前端：新增一个独立页面按“北京时间某天”查看新增配对记录明细（基于入库时间 created_at），并从仪表盘抽屉提供“查看历史（按天）”入口。
  - 后端：为 `/stats/paired-diaries/increase` 增加可选 `until_ms`，支持按区间（左闭右开）精确统计某一天的新增。
  - 详情页：附件区移动到页面末尾，并为每张缩略图展示 `图N` 标签；无附件时显示空状态。
- 核心变更（计划）：
  - 后端：`backend/app/api/stats.py`（新增 `until_ms` 过滤）。
  - 前端：新增 `frontend/src/pages/PairedIncreaseHistory.jsx`；更新 `frontend/src/App.jsx`、`frontend/src/pages/Dashboard.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/utils/time.js`。
  - 测试：扩展 Playwright e2e（历史页可见性、附件区图号与位置）。
- 遗留/约束：
  - 时间口径统一：页面按北京时间选日，接口按 UTC ms 区间请求，后端按 created_at 过滤。
