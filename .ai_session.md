## [2026-02-20 09:55] - 任务：外网访问不到排障（DNS 双栈 + 恢复 GitLab push）
- 原始需求：用户反馈 younote 访问不到；要求排查部署问题并恢复访问，然后推送 push。
- 实现目标/逻辑：
  - 服务侧确认：`31011` 前端与 `31010` HTTPS 入口在服务器本机均可正常返回；Nginx `31010 -> 31011` 反代链路正常。
  - 根因定位：`u.pscly.cn` 之前仅有 AAAA（IPv6）记录，没有 A（IPv4）记录，导致 IPv4-only 网络下“域名无法解析/无法访问”。
  - 修复策略：通过 ddns-go 启用 IPv4 更新，为 `u.pscly.cn/u1.pscly.cn` 及通配符补齐 A 记录，并保留 AAAA（双栈）。
  - push 保障：GitLab 因数据库迁移失败（`gpg_key_subkeys.user_id` 存在 NULL 触发 check constraint）导致容器重启循环，先清理脏数据并重启 GitLab，使 SSH push 恢复正常。
- 核心变更：
  - 运维（不入仓库）：`/root/docker/ddns-go/ddns-go/.ddns_go_config.yaml` 启用 IPv4 更新 + 域名列表
  - 文档：`DEPLOY_DOCKER.md` 补充 IPv4/IPv6 访问排障说明
- 遗留/约束：
  - IPv4 访问仍依赖公网 IPv4 + 路由器端口映射；若处于 CGNAT，需要 Tunnel/FRP/VPS 反代方案。
  - DNS 变更可能存在缓存，个别网络需要等待 TTL 或刷新缓存后生效。

## [2026-01-25 11:21] - 任务：补齐 Docker 部署（前端+后端）
- 原始需求：为项目补齐 Dockerfile + docker-compose；不要引入 PostgreSQL 镜像；让服务器在远端可直接 `docker compose` 部署与更新。
- 实现目标/逻辑：
  - 后端：基于 Python 3.13 + `uv.lock` 构建镜像，使用 `uv sync` 安装依赖；运行 `python backend/run.py`（生产默认关闭 reload）。
  - 前端：Vite 构建产物用 Nginx 提供静态服务，并在 Nginx 侧把 `/api`、`/docs` 等转发到后端容器，保证浏览器同源访问（前端默认 `API_BASE_URL=/api`）。
  - 数据持久化：SQLite DB 与访问日志目录通过 volume 绑定到宿主机（`./data`、`./logs`），更新镜像不丢数据。
- 核心变更：新增 `docker-compose.yml`、`backend/Dockerfile`、`frontend/Dockerfile`、`frontend/nginx.conf`、`.dockerignore` 等部署相关文件。
- 遗留/约束：
  - 不包含 PostgreSQL 镜像；如需切换到远程 PG，仅通过 `.env`/环境变量配置 `DATABASE_URL`。
  - 服务器更新流程：`git pull` 后执行 `docker compose up -d --build`（或 `docker-compose up -d --build`）。

## [2026-01-26 09:45] - 任务：新增部署与CI技能（docker-compose + GitLab CI/CD）
- 原始需求：你现在开发个 skill ，关于 docker-compose 部署相关，和gitlab cicd 相关(基于这个项目的架构，你开发一下呢)
- 实现目标/逻辑：
  - 基于当前仓库既有部署文件（`docker-compose.yml`、`backend/Dockerfile`、`frontend/Dockerfile`、`frontend/nginx.conf`、`.gitlab-ci.yml`）提炼可复用流程与检查清单。
  - Skill 面向 Codex：在用户提出“容器化部署 / docker compose / 自动发布 / GitLab Runner”等需求时，指导按最小改动落地，并保持数据持久化与 `.env` 不被流水线覆盖。
- 核心变更：新增 `.codex/skills/yournote-docker-gitlab/SKILL.md`、`.codex/skills/yournote-docker-gitlab/references/compose.md`、`.codex/skills/yournote-docker-gitlab/references/gitlab-ci.md`。
- 遗留/约束：
  - 不自动执行 `git commit`（除非用户明确要求）。
  - 延续约束：不引入 PostgreSQL 容器；默认 SQLite + volume 持久化，切换 PG 仅通过 `DATABASE_URL` 外部接入。

## [2026-01-26 09:58] - 任务：将部署与CI Skill 全局化并完善
- 原始需求：你现在把这个skill 开发成全局的，记得修改的非常完善和非常完美，
- 实现目标/逻辑：
  - 完善 `yournote-docker-gitlab` 的触发描述、工作流、排障与运维安全清单，使其不仅适配本仓库，也能作为类似架构项目的通用范式。
  - 将 Skill 安装到全局目录 `C:/Users/pscly/.codex/skills/`，使其在任意项目中可用（仓库内版本作为“源代码/开发版本”保留）。
- 核心变更：
  - 完善 Skill：更新 `.codex/skills/yournote-docker-gitlab/SKILL.md`、补充与增强 `references/*`（新增 `ops-security.md`、`troubleshooting.md`、`templates.md`）。
  - 全局安装：已同步复制到 `C:/Users/pscly/.codex/skills/yournote-docker-gitlab/`。
- 遗留/约束：
  - 全局安装需要写入用户目录（可能触发权限确认）。
  - 仍保持 CI 不覆盖服务器 `.env`、compose 持久化 `./data` 与 `./logs` 的原则。

## [2026-01-26 14:31] - 任务：倾向采用 SSH 远端部署方案（GitLab CI）
- 原始需求：那我感觉 SSH 方案会更好一些的感觉
- 实现目标/逻辑：
  - 采用“Runner 不在目标服务器”的发布模型：CI 通过 `rsync` 同步代码到服务器 `DEPLOY_DIR`，再通过 `ssh` 在服务器上执行 `docker compose up -d --build --remove-orphans`。
  - 继续遵循：CI 不覆盖服务器 `.env`；同步时排除 `data/`、`logs/` 保留持久化数据。
- 核心变更：待办把 `.gitlab-ci.yml` 调整为 SSH 部署 Job，并要求在 GitLab CI Variables 配置 `DEPLOY_HOST/DEPLOY_USER/DEPLOY_DIR/DEPLOY_PORT/DEPLOY_SSH_PRIVATE_KEY` 等。
- 遗留/约束：需确认目标服务器已安装 Docker + Compose v2、以及 deploy 用户执行 docker 的权限策略（docker group 或受限 sudo）。

## [2026-01-26 15:23] - 任务：主页账号列表默认收起
- 原始需求：把主页的「账号列表」改成默认就是收起的，然后自动提交并推送到 Git（GitHub+GitLab）。
- 实现目标/逻辑：
  - 将账号列表的默认折叠状态改为“默认收起”，且保留用户手动展开/收起并记忆的能力。
  - 为避免旧版本本地存储的历史偏好影响新默认值，对 localStorage key 进行 v2 版本化。
- 核心变更：更新 rontend/src/pages/Dashboard.jsx（默认折叠逻辑与存储 key）。
- 遗留/约束：无。

## [2026-01-27 17:25] - 任务：前端文案统一（日记->记录）
- 原始需求：你现在把前端里面所有日记两个字 都换成记录，然后提交推送。
- 实现目标/逻辑：
  - 仅在 frontend 目录内做全文字面替换，把所有中文"日记"统一改为"记录"。
- 核心变更：批量更新 frontend 下相关页面/测试/README/HTML 文案。
- 遗留/约束：无。

## [2026-01-27 17:50] - 任务：全仓库“体检 + 代码质量/安全/可维护性”优化
- 原始需求：你看看各个地方，是否有需要好好详细优化一下的地方呢？你把需要好好优化的地方都好好优化和完整完善一下呢?
- 实现目标/逻辑：
  - 先做全仓库体检，优先处理高风险/高收益问题（安全信息泄露、吞异常、可观测性差、版本信息不一致、脚本健壮性等）。
  - 后端优先：统一版本来源；API 层 5xx 错误不回显内部异常；访问日志错误信息脱敏且不影响业务。
  - 前端与脚本：在不改变现有业务行为的前提下，提升稳定性与可维护性（API 客户端/错误提示/一键脚本默认值与输出信息）。
  - 变更保持“最小必要”，避免引入大范围重构；涉及删除/移动本地文件（如测试账号/临时数据）将先征询用户确认。
- 核心变更：
  - 后端：新增 `backend/app/utils/errors.py`（异常信息脱敏/截断工具）；更新 `backend/app/main.py`（统一版本来源、访问日志错误脱敏且可观测、/health 增加 DB 探测）；更新 API 端点 `backend/app/api/accounts.py`、`backend/app/api/diaries.py`、`backend/app/api/sync.py`、`backend/app/api/publish_diary.py`（5xx 不回显内部异常、落库错误信息截断、补充关键异常日志）。
  - 前端：更新 `frontend/src/config.js`（API_BASE_URL 归一化：空值回退、去尾斜杠）；更新 `frontend/src/components/SyncMonitor.jsx`（补齐 hooks 依赖，lint 0 warning）。
  - 脚本：更新 `run.bat`（端口默认值 + 输出更清晰）、`stop.bat`（文案修正）。
- 遗留/约束：
  - 全仓库文件编码保持 UTF-8（无 BOM）；Windows/pwsh7 环境。
  - MCP 工具如不可用则降级为本地命令与人工审查（本次出现过 MCP Transport 关闭的情况）。

## [2026-02-04 23:03] - 任务：仪表盘新增配对记录按入库时间统计
- 原始需求：主页“配对记录数”的“今天新增”不应只按记录日期判断；需要按数据库对比统计，包含“今天才解锁的以前记录”也算新增；并要求改好后直接提交并 push。
- 实现目标/逻辑：
  - 后端新增接口按 `diaries.created_at`（首次入库时间）统计窗口内“新增配对记录”，并返回明细 + 作者信息，避免前端只拉前 N 条导致漏算。
  - 前端仪表盘新增“统计起点”切换（昨日 20:00 / 今日 00:00，北京时间），切换后只刷新新增统计，不触发全页加载；统计范围包含停用账号（按你的选择）。
- 核心变更：
  - 后端：扩展 `DiaryResponse` 暴露 `created_at/updated_at`；新增 `/stats/paired-diaries/increase` 端点与响应模型。
  - 前端：`Dashboard` 的“新增配对记录”从“按记录日期过滤”改为调用后端统计接口；新增统计起点 Segmented 切换并持久化 localStorage。
- 遗留/约束：
  - 若后续数据量显著增大，建议为 `diaries.created_at` 增加索引以进一步降低统计查询耗时（本次优先保持最小变更，先保证口径正确）。

## [2026-02-04 23:50] - 任务：记录图片缓存（解析 `[图13]` 并保存到本地 DB）
- 原始需求：nideriji 的图片接口在浏览器里会显示为 `blob:`（不可直接复用 URL）；希望后端读取记录后把图片保存下来（小图片，存 DB 即可），前端查看记录时能直接访问本项目的图片地址并展示附件。
- 实现目标/逻辑：
  - 后端：新增图片缓存表 `cached_images`（SQLite=BLOB / Postgres=BYTEA），按 `(nideriji_userid, image_id)` 唯一定位；提供图片接口 `GET /api/diaries/{diary_id}/images/{image_id}`，优先读本地缓存，不存在则用账号 `auth_token` 从上游 `f.nideriji.cn` 拉取并缓存。
  - 附件信息：`GET /api/diaries/{diary_id}` 返回 `attachments.images`，把正文里的 `[图13]` 映射成稳定 URL，供前端原位渲染。
  - 缓存策略：同步完成后后台“尽量预拉取”本次新增/更新且正文含图片占位符的记录；若仍缺失则图片接口兜底懒加载。
  - 可控性：新增图片缓存相关配置（开关、超时、最大大小、单次预拉取上限、上游 base url）。
- 核心变更：
  - 后端：新增 `backend/app/models/cached_image.py`；新增 `backend/app/services/image_cache.py`；扩展 `backend/app/api/diaries.py`（详情返回 attachments + 新增图片路由）；扩展 `backend/app/services/collector.py`（同步成功后后台预拉取图片）。
  - 前端：更新 `frontend/src/pages/DiaryDetail.jsx`，将正文中的 `[图N]` 原位替换为图片，并增加“附件（图片）”区用于预览。
  - 配置：更新 `.env.example`，补充图片缓存相关环境变量示例。
- 遗留/约束：
  - 图片接口依赖访问门禁 Cookie（同源部署最稳）；若跨域部署需确保 Cookie 的 SameSite/Secure 配置与 CORS 策略匹配。
  - 当前预拉取为“尽力而为”策略：失败（403/404/网络）仅落库状态，不影响同步成功。

## [2026-02-05 11:20] - 任务：新增配对记录历史页（按天）+ 详情页附件底部汇总
- 原始需求：
  - 在“新增配对记录”页面/入口里能看到历史新增记录（昨天、前天、某天）。
  - 每篇记录阅读页面末尾展示该记录的所有附件，并明确标注每张图片的图号（图几）。
- 实现目标/逻辑：
  - 前端：新增一个独立页面按“北京时间某天”查看新增配对记录明细（基于入库时间 created_at），并从仪表盘抽屉提供“查看历史（按天）”入口。
  - 后端：为 `/stats/paired-diaries/increase` 增加可选 `until_ms`，支持按区间（左闭右开）精确统计某一天的新增。
  - 详情页：附件区移动到页面末尾，并为每张缩略图展示 `图N` 标签；无附件时显示空状态。
- 核心变更（计划）：
  - 后端：`backend/app/api/stats.py`（新增 `until_ms` 过滤）。
  - 前端：新增 `frontend/src/pages/PairedIncreaseHistory.jsx`；更新 `frontend/src/App.jsx`、`frontend/src/pages/Dashboard.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/utils/time.js`。
  - 测试：扩展 Playwright e2e（历史页可见性、附件区图号与位置）。
- 遗留/约束：
  - 时间口径统一：页面按北京时间选日，接口按 UTC ms 区间请求，后端按 created_at 过滤。

## [2026-02-05 18:31] - 任务：记录列表升级（全局搜索 + 高级筛选 + 分页）
- 原始需求：现在其实已经很不错了，看看有没有办法更新，让其变得更好用、更得心应手；当前痛点主要是“找记录麻烦”，电脑浏览器为主。
- 实现目标/逻辑：
  - 后端：新增 `GET /api/diaries/query`，支持按关键字（标题/正文）、范围（仅配对用户/全部）、账号、作者、日期范围进行筛选，并返回 `count + items` 以支持前端分页。
  - 前端：`/diaries` 顶部提供“搜索工作台”（搜索框 + 范围/账号/日期/作者筛选），并把条件同步到 URL（可分享/可复现），同时记住用户的范围与分页大小偏好（localStorage）。
  - 交互：支持快捷键 `/` 聚焦搜索框、`Esc` 清空搜索并重新查询（保留其他筛选条件）。
  - 性能：为 SQLite/PG 增加必要索引（`ts/created_at` 等），保证数据量增长后分页仍然可用。
- 核心变更（计划）：
  - 后端：`backend/app/api/diaries.py`（新增查询路由）；`backend/app/schemas/diary_query.py`（新增响应模型）；`backend/app/database.py`（新增索引自修复）。
  - 前端：`frontend/src/services/api.js`（新增 `diaryAPI.query`）；`frontend/src/pages/DiaryList.jsx`（改为服务端查询驱动 + URL 同步 + 分页）；新增 Playwright e2e `frontend/tests/diary-search.spec.js`。
- 遗留/约束：
  - 先实现 LIKE 方案（兼容 SQLite/PG），后续如数据量巨大再评估 SQLite FTS5 / PG tsvector 的全文检索升级。
  - 仍保持全仓库 UTF-8（无 BOM）；不自动执行 `git commit`（除非用户明确要求）。

## [2026-02-05 20:58] - 任务：发布历史增强（多选项 + 按天汇总日终稿）
- 原始需求：发布历史更新一下，可以看到多个选项；查看所有日子的日记（每个日子展示最后一篇日记/最后一次发布内容）。
- 实现目标/逻辑：
  - 前端：在“发布历史”页提供两种查看方式：
    1) 按日期筛选：查看某天的所有发布（保留原有能力）
    2) 按天汇总（日终稿）：每个日期只展示该日最后一次发布（用于“看所有日子的最终版本”）
  - 后端：新增按天汇总接口返回 `count + items`，items 为每个日期最新 run 的列表项（RunId/日期/账号数/成功失败/时间），前端点击即可查看详情与内容。
  - 可读性：发布详情弹窗补充展示“发布内容”，避免只能看每账号结果却看不到日记正文。
- 核心变更（计划）：
  - 后端：新增 `GET /api/publish-diaries/runs/latest-by-date`；新增 schema `PublishDiaryRunsLatestByDateResponse`（count + items）。
  - 前端：`frontend/src/pages/PublishDiary.jsx` 增加“查看方式”切换与按天分页；`frontend/src/services/api.js` 增加对应 API。
- 遗留/约束：
  - “日终稿”的判定口径：同一天多次发布时，取该 date 的最大 run_id（最后一次发布）。

## [2026-02-05 22:09] - 任务：日终稿列表增强（内容预览 + 可调长度）
- 原始需求：继续完善发布历史，让“查看所有日子的日记（每个日子的最后一篇）”更顺手，列表里能直接预览内容。
- 实现目标/逻辑：
  - 后端：按天汇总接口支持可选返回 `content_preview`，并附带 `content_len` / `content_word_count_no_ws`；支持通过 `include_preview` / `preview_len` 控制是否返回与预览长度。
  - 前端：在“按天汇总（日终稿）”区域增加“显示内容预览”开关与“预览长度”设置（localStorage 记忆）；桌面端表格新增“内容预览”列并提供 tooltip；移动端卡片内直接展示预览块。
- 核心变更：
  - 后端：`backend/app/api/publish_diary.py`、`backend/app/schemas/publish_diary.py`、`backend/app/schemas/__init__.py`
  - 前端：`frontend/src/pages/PublishDiary.jsx`
- 遗留/约束：
  - 预览为“列表轻量预览”，完整正文仍以“查看”弹窗为准（避免列表接口返回过大正文）。

## [2026-02-05 22:35] - 任务：发布历史新增“按天连续阅读（日终稿）”时间线模式
- 原始需求：用户选择方案 1（时间线连续阅读）：希望“看所有日子的最后一篇”能像时间线一样连续展开阅读，尽量少点弹窗。
- 实现目标/逻辑：
  - 前端在“发布历史”页增加第三种查看方式：按天连续阅读（日终稿）。
  - 展示形态：使用 Collapse 折叠面板承载“每一天的日终稿”；进入页面默认展开最新一天，方便立即阅读。
  - 体验细节：分页切换时自动清理上一页残留的展开项，确保“默认展开最新一天”的行为稳定；并补齐 Hook 依赖避免 eslint 警告。
  - 性能策略：列表仍用按天汇总接口拿 run 列表；正文在展开时按需调用 `GET /publish-diaries/runs/{run_id}` 拉取（避免一次性返回全文导致 payload 过大）。
  - 操作：支持“展开最近 7 天 / 折叠全部”，以及每条支持“查看（含每账号结果）/ 载入内容 / 查看当天全部发布”。
- 核心变更：
  - 前端：`frontend/src/pages/PublishDiary.jsx`
  - 测试：`frontend/tests/publish-history.spec.js`
- 遗留/约束：
  - 正文按需加载：首次展开某天会触发一次网络请求；若后续需要更丝滑，可考虑加“预取最近 N 天”开关。

## [2026-02-06 17:17] - 任务：记录列表搜索升级 + 移动端阅读模式（pgsql 优化）
- 原始需求：
  - “Implement the plan.”（把项目继续优化开发，变得非常好用）
  - 补充约束：数据库使用 PostgreSQL（pgsql），需要特别注意查询与索引。
- 实现目标/逻辑：
  - 后端 `GET /api/diaries/query`：
    - 新增 `q_mode(and/or)`、`q_syntax(smart/plain)`，并支持 `-排除词` 与 `"短语"`（smart 模式）。
    - 新增 `include_stats/include_preview` 以控制列表成本；返回 `took_ms`（后端耗时）与 `normalized`（解析后的查询结构）。
    - 预览升级：优先截取“命中附近片段”，提升搜索结果可读性。
    - pgsql 优化：PostgreSQL 下使用 ILIKE，避免 `lower(col)` 影响潜在索引命中。
  - 数据库索引（兼容 SQLite/PG 的自修复策略）：
    - 为 diaries 增加常用筛选复合索引（account/user/date/id）。
    - 为 paired_relationships 增加 join + is_active 过滤的复合索引。
  - 前端 `记录列表`：
    - 搜索工作台新增 AND/OR 切换、语法模式切换；查询耗时展示；命中词高亮。
    - 参数同步到 URL（可分享/可复现）：mode/syntax/stats/view/multi 等。
    - 移动端新增“阅读模式”：展开即读（按需拉取详情），支持“仅展开一条/多条展开”，并支持 `[图13]` 图片占位渲染。
  - 测试：补齐 Playwright 用例覆盖搜索控件与移动端阅读模式展开/收起。
- 核心变更：
  - 后端：`backend/app/api/diaries.py`、`backend/app/schemas/diary_query.py`、`backend/app/schemas/__init__.py`、`backend/app/database.py`
  - 前端：`frontend/src/pages/DiaryList.jsx`
  - 测试：`frontend/tests/diary-search.spec.js`、新增 `frontend/tests/diary-reading.spec.js`
- 遗留/约束：
  - 当前仍以 LIKE/ILIKE 实现全文检索，数据量巨大时可评估 PG `pg_trgm`（GIN/GiST）进一步提速（需数据库权限）。
  - 未实现 `/api/diaries/batch` 批量详情接口；当前阅读模式按需单条拉取，已能满足移动端“少跳转连续阅读”的核心体验。

## [2026-02-06 17:37] - 任务：版本号统一 + e2e 测试稳定性补强
- 原始需求：实现计划后做验证与收尾，确保可持续迭代。
- 实现目标/逻辑：
  - 版本号：将本次“功能增强（找记录体验升级）”按 SemVer 归类为 Minor，统一升级到 `0.5.0`，避免前后端/文档显示不一致。
  - 测试稳定性：修复 Playwright 在存在 `http_proxy/https_proxy` 环境变量时对 `webServer` 可用性探测的“代理误判”，确保 `npm run test:e2e` 可自启动前端并稳定运行。
  - 空数据体验：当暂无账号/后端不可达时，记录列表页仍显示搜索工作台，并以 Alert 引导去“账号管理”，避免页面行为随数据状态改变而导致用户/测试困惑。
- 核心变更：
  - 版本号：`pyproject.toml`、`frontend/package.json`、`frontend/package-lock.json`、`backend/app/main.py`
  - 测试：`frontend/playwright.config.js`（补齐 `NO_PROXY/no_proxy`）
  - 前端：`frontend/src/pages/DiaryList.jsx`（“暂无账号”提示改为 Alert + 仍显示搜索工作台；新增“字数”开关）
- 遗留/约束：
  - 后端未在 e2e 中自动启动；当前 e2e 以“前端 UI 交互/URL 同步/阅读模式”为主，数据与接口可在开发机上配合后端服务进一步跑全量用例。

## [2026-02-20 06:15] - 任务：日记书签（收藏）功能
- 原始需求：给某篇记录添加/取消书签；提供独立“书签”页面集中查看。
- 实现目标/逻辑：
  - 存储：在 `diaries` 表新增可空字段 `bookmarked_at`（epoch ms），用于筛选与按收藏时间排序；不引入新表。
  - API：提供幂等 set/clear（避免 toggle 竞态），并支持批量取消书签；`GET /api/diaries/query` 支持 `bookmarked` 过滤与 `order_by=bookmarked_at`。
  - 前端：列表页/详情页都有书签按钮；新增 `/bookmarks` 页面（默认按收藏时间倒序、支持搜索/筛选/排序/批量取消/导出 Markdown）。
  - 测试：后端 unittest（TDD）+ 前端 Playwright 关键链路 E2E（mock 补齐新接口）。
  - 流程：开发前 `git pull`；完成后检查 GitLab CI deploy job 全绿，并做线上/同源 /api 可达验证。
- 核心变更（计划）：`backend/app/models/diary.py`、`backend/app/database.py`、`backend/app/api/diaries.py`、`frontend/src/pages/DiaryList.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/App.jsx`、`frontend/tests/testBase.js`。
- 遗留/约束：本迭代不做“删除记录/软删除/防回流”；批量操作仅当前页；保持无 Alembic、靠 `_ensure_schema` 自修复。

## [2026-02-07 15:25] - 任务：发布更新日记失败（上游网络抖动）排查与修复方案落地
- 原始需求：部署后的 younote 不能发布更新日记（发布/更新日记失败）。
- 实现目标/逻辑：
  - 根因定位：后端容器访问 nideriji 上游接口时出现间歇性 `httpx.ConnectError: All connection attempts failed`，导致“发布 run 的每个账号 item 均失败”，并且同步接口同时间段也会失败。
  - 修复思路：在后端对访问 nideriji 的 HTTP 请求增加“重试 + 指数退避 + 少量抖动（jitter）”，并在落库/日志里增强错误信息（标注已重试次数与建议排查点），降低短时网络抖动导致的失败率。
  - 约束：保持现有业务逻辑不变（401/403 仍按“自动重登刷新 token 再重试一次发布”的策略）；仅对网络类异常做重试，不对业务性 HTTP 状态码做盲目重试。
- 核心变更：
  - 新增：`backend/app/services/http_client.py`（上游请求重试封装 `request_with_retry`，失败时在异常对象上打标 `yournote_attempts`）
  - 配置：`backend/app/config.py`（新增 `nideriji_api_base_url` 与重试/退避配置项，默认“中等”档）
  - 同步：`backend/app/services/collector.py`（sync/login/all_by_ids 接入重试；同步日志错误信息更可读并包含“已重试 N 次”）
  - 发布：`backend/app/services/publisher.py`（write 接入重试；仍保持 401/403 自动重登逻辑）
  - 后台发布：`backend/app/services/background.py`（错误文案统一：网络异常/超时包含“已重试 N 次”，并进行截断/去控制字符）
  - 发布 API：`backend/app/api/publish_diary.py`（错误文案统一：网络异常/超时包含“已重试 N 次”）
- 遗留/约束：
  - 若上游长期不可达，重试只会延长失败耗时；需要配合运维层面检查服务器出站网络/DNS 或确认上游是否故障。
  - 若希望“更快失败/更强重试”，可在 `.env` 中调整 `NIDERIJI_HTTP_MAX_ATTEMPTS`、`NIDERIJI_HTTP_RETRY_BACKOFF_SECONDS` 等参数。

## [2026-02-07 19:18] - 任务：全站交互/易用性优先的“通通优化”落地（默认勾选 U01/U02/U03/U04/U05/U07/U09）
- 原始需求：
  - “对这个项目进行完整详细的优化，现有的操作逻辑有些地方不太好用和不方便…全部给通通优化了”
  - “Implement the plan.”
- 实现目标/逻辑：
  - 优先目标：交互/易用性（同时兼顾性能与稳定性），数据库以 PostgreSQL 为主，但保持 SQLite 可用。
  - 后端：
    - 新增仪表盘聚合接口，减少前端 N+1 请求，提升“账号多时”的加载速度与稳定性。
    - 新增账号 Token 批量校验接口，避免前端并发打爆与等待时间过长。
    - 增加 `X-Request-Id` 贯穿链路，并规范未捕获异常的响应与日志串联，便于排障。
  - 前端：
    - 引入统一的页面状态与错误文案提取（加载/空态/错误态一致），减少各页面重复逻辑。
    - 记录列表：优化筛选交互（粘性搜索栏 + 高级筛选抽屉 + 一键清空），移动端更顺手。
    - 同步记录：增加按账号聚合视图与“重试最近失败同步”入口。
  - 脚本与文档：补齐 Linux 一键启动/停止脚本（与现有 Windows `run.bat/stop.bat` 并存）。
- 核心变更（计划落点）：
  - 后端：`backend/app/api/stats.py`、`backend/app/api/accounts.py`、`backend/app/main.py`、`backend/app/schemas/*`
  - 前端：`frontend/src/components/*`、`frontend/src/utils/*`、`frontend/src/pages/{Dashboard,DiaryList,AccountManage,SyncLogs}.jsx`、`frontend/src/services/api.js`
  - 脚本：`run.sh`、`stop.sh`、`README.md`
- 遗留/约束：
  - 当前会话运行环境为 Ubuntu + zsh；AGENTS 模板中提到的 PowerShell `OutputEncoding` 指令不适用（改为保证所有新增/修改文件为 UTF-8 无 BOM）。
  - 按系统约束不自动执行 `git commit/push`；但会提供建议的 commit message 方便你手动提交。

## [2026-02-07 19:59] - 任务：按默认勾选项完成优化落地 + 回归验证
- 原始需求：Implement the plan（默认勾选 U01/U02/U03/U04/U05/U07/U09）。
- 实现目标/逻辑（落地结果）：
  - U03 仪表盘提速：新增后端聚合接口 `/api/stats/dashboard`，前端仪表盘改为单请求获取“账号 + 概览 + 最近配对记录”，彻底移除前端 N+1（按账号取配对关系+记录列表）的慢路径。
  - U04 批量校验：新增 `/api/accounts/validate-batch`，前端“账号管理”改为一次请求批量刷新 token 状态，避免并发打爆与等待时间过长。
  - U09 可观测性：后端引入 `X-Request-Id`（请求级 ID），并在异常响应/校验异常中补齐该响应头；访问日志新增 `rid=` 字段，便于串联排障。
  - U01 体验一致性：前端新增 `PageState` 与 `getErrorMessage`，统一“加载/错误”展示与错误信息抽取（含 request_id）。
  - U02 记录列表：顶部筛选区改为粘性（sticky），移动端新增“筛选抽屉”（桌面端保持原有完整控件，避免破坏既有使用习惯与测试）。
  - U07 同步记录：新增“按账号”视图（调用 `/api/sync/logs/latest`）与一键重试/立即同步按钮（复用 `waitForLatestSyncLog` 等待结果反馈）。
  - U05 Linux 一键：新增 `run.sh/stop.sh`，并更新 README 给出 Ubuntu 一键启动方式；新增 `.run/` 到 `.gitignore`（存放 pid）。
- 核心变更：
  - 后端：
    - 新增：`backend/app/api/stats.py` -> `GET /stats/dashboard`
    - 新增：`backend/app/api/accounts.py` -> `POST /accounts/validate-batch`
    - 增强：`backend/app/main.py`（request_id 中间件 + 异常处理器）
    - 增强：`backend/app/utils/access_log.py`（访问日志增加 rid）
    - schema：`backend/app/schemas/stats.py`、`backend/app/schemas/account.py`、`backend/app/schemas/__init__.py`
  - 前端：
    - 新增：`frontend/src/utils/errorMessage.js`、`frontend/src/components/PageState.jsx`
    - 改造：`frontend/src/pages/Dashboard.jsx`（使用 `/stats/dashboard`）
    - 改造：`frontend/src/pages/AccountManage.jsx`（使用 `/accounts/validate-batch`）
    - 改造：`frontend/src/pages/DiaryList.jsx`（移动端筛选抽屉 + sticky 顶部）
    - 改造：`frontend/src/pages/SyncLogs.jsx`（按账号视图 + 重试同步）
    - 客户端：`frontend/src/services/api.js`（新增 `statsAPI.dashboard`、`accountAPI.validateBatch`）
    - 测试配置：`frontend/playwright.config.js`（webServer 命令加 `--host 127.0.0.1`，便于受限环境）
  - 脚本/文档：`run.sh`、`stop.sh`、`README.md`、`.gitignore`
- 验证与回归：
  - 后端：使用 `./.venv/bin/python -m compileall backend/app` 通过；`cd backend && ../.venv/bin/python -c "from app.main import app"` 通过。
  - 前端：`npm run lint`、`npm run build` 通过。
  - e2e：`npm run test:e2e` 在当前沙箱环境下因禁止监听端口（EPERM）无法启动 webServer；建议在本机正常终端环境（允许监听 localhost）运行 Playwright。

## [2026-02-07 20:55] - 任务：优化收尾（版本号/提交/推送）
- 原始需求：
  - “Implement the plan.”
  - “改完之后直接 git push”
- 实现目标/逻辑：
  - 为 Linux 启动/停止脚本补齐可执行位（`chmod +x`），避免用户需要手动 `bash run.sh`。
  - 按 SemVer 将本轮“多项体验增强”归类为 Minor，版本号从 `0.5.0` 升级到 `0.6.0`（前端/后端/文档显示一致）。
  - 用一次提交把本轮优化集中落库，便于审阅与回滚；随后推送到 main 的上游（`origin/main`）。
- 核心变更（计划/即将完成）：
  - 脚本权限：`run.sh`、`stop.sh`
  - 版本号：`pyproject.toml`、`frontend/package.json`、`frontend/package-lock.json`、`backend/app/main.py`
  - 本轮优化代码：见上一条任务记录（U01/U02/U03/U04/U05/U07/U09）
- 遗留/约束：
  - 当前沙箱环境禁用端口监听，Playwright e2e 需在本机环境跑；若 `git push` 受网络/SSH 限制，需要在非沙箱或具备网络权限环境执行。

## [2026-02-07 22:00] - 任务：发布日记编辑器增强（时间标记转换 + 5s 自动保存草稿）
- 原始需求：
  - 发布日记正文可能包含 `> xx:xx:xx`，需要一键转换为 `[xx:xx:xx]`（英文方括号）。
  - “编辑文字的面板：编辑后每 5s 自动保存草稿”（防丢、少打扰）。
- 实现目标/逻辑：
  - 前端发布页新增两个按钮：`时间转换` / `撤销转换`，用于把正文中的 `> HH:MM:SS` 转为 `[HH:MM:SS]`，并支持一键撤销上一条转换。
  - 新增草稿自动保存：正文停止输入约 5 秒后自动保存草稿（防抖），采用“安静提示”方式在页面状态区展示 `pending/saving/saved/error`，避免频繁 toast 打断输入。
  - 切换日期前：若检测到当前日期正文未保存，会先自动保存；保存失败则阻止切换日期，避免被 `loadDraft` 覆盖造成丢内容。
  - 版本号按 SemVer 归类为 Minor：`0.6.0 -> 0.7.0`（前端/后端一致）。
- 核心变更：
  - 前端：`frontend/src/pages/PublishDiary.jsx`（按钮 + 规则转换 + 自动保存）
  - 测试：`frontend/tests/publish-time-convert.spec.js`、`frontend/tests/publish-autosave.spec.js`
  - 版本号：`pyproject.toml`、`frontend/package.json`、`frontend/package-lock.json`、`backend/app/main.py`
- 遗留/约束：
  - 自动保存默认 5 秒防抖；若后续希望支持“最长每 N 秒强制保存/仅失败提示”等，可再做细化配置。

## [2026-02-07 23:47] - 任务：第二轮打磨（阅读体验优先 + 发布页自动保存/时间转换增强）
- 原始需求：
  - “你现在继续好好打磨一下，让产品更加的完美完善”
  - 发布页：时间转换支持 `> HH:MM`；自动保存希望“停输入 5s + 连续输入 30s 保底”
  - 阅读体验：详情页子模块失败要可见、可重试（不再只 `console.error`）
- 实现目标/逻辑：
  - `DiaryDetail`：把“主数据加载失败”和“列表/配对/历史”等子模块失败分层展示；子模块失败就地显示错误提示 + 重试，不刷屏 toast。
  - `PublishDiary`：时间转换规则升级为同时支持 `HH:MM` / `HH:MM:SS`；自动保存升级为“5s 防抖 + 30s 保底”，并补齐失败后的“重试自动保存”按钮。
  - E2E：补齐 `> 12:34 -> [12:34]` 用例；新增“保底保存”用例（通过注入 `__YOUNOTE_E2E_PUBLISH_DRAFT_FORCE_MS__` 缩短等待）。
  - 版本号按 SemVer 归类为 Patch：`0.7.0 -> 0.7.1`。
- 核心变更：
  - 前端：`frontend/src/pages/DiaryDetail.jsx`（列表/配对/历史加载错误可见 + 重试；页面级错误用 `PageState`）
  - 前端：`frontend/src/pages/PublishDiary.jsx`（时间转换扩展；自动保存保底；错误重试按钮）
  - 测试：`frontend/tests/publish-time-convert.spec.js`、`frontend/tests/publish-autosave.spec.js`
  - 版本号：`pyproject.toml`、`frontend/package.json`、`frontend/package-lock.json`、`backend/app/main.py`
- 遗留/约束：
  - `__YOUNOTE_E2E_PUBLISH_DRAFT_FORCE_MS__` 仅用于测试注入；产品默认仍是 30 秒保底。
  - 若要进一步统一所有页面错误文案，可后续把 `AllUsers`/`UserDetail` 等页面也统一改为 `getErrorMessage`。

## [2026-02-08 00:06] - 任务：继续打磨（用户页错误一致性 + 修复 Vite 代理 host）
- 原始需求：用户确认“ok 你继续”，继续做高收益细节打磨。
- 实现目标/逻辑：
  - 用户页体验一致性：`AllUsers` / `UserDetail` 的“加载失败/重试”不再只 toast，改为页面内 `PageState` 承载（可见、可重试、风格统一）。
  - 开发体验修复：`.env` 常用 `BACKEND_HOST=0.0.0.0` 仅适合后端监听；此前前端 Vite proxy 会尝试连接 `0.0.0.0` 导致无法正常代理。改为 proxy 侧自动归一化到 `127.0.0.1`，并支持可选 `BACKEND_PROXY_HOST` 指向远端后端。
  - 版本号按 SemVer 归类为 Patch：`0.7.1 -> 0.7.2`。
- 核心变更：
  - 前端：`frontend/src/pages/AllUsers.jsx`、`frontend/src/pages/UserDetail.jsx`（统一错误展示 + 重试）
  - 前端：`frontend/vite.config.js`（新增 proxy host 归一化；支持 `BACKEND_PROXY_HOST`）
  - 配置示例：`.env.example`（补充 `BACKEND_PROXY_HOST` 说明）
  - 版本号：`pyproject.toml`、`frontend/package.json`、`frontend/package-lock.json`、`backend/app/main.py`
- 遗留/约束：
  - 现有 e2e 在无后端场景下会出现 proxy 连接失败日志（不影响用例通过）；若需要彻底消噪，可再做“测试环境统一 mock /api/**”的全局夹具。

## [2026-02-08 01:22] - 任务：继续打磨（错误提示一致性 + Playwright E2E Mock 基座）
- 原始需求：
  - “你现在继续好好打磨一下，让产品更加的完美完善”
  - “Implement the plan.”
  - “都推送吧”
- 实现目标/逻辑：
  - 前端：把更多页面的错误提示统一收敛到 `getErrorMessage`（自动提取后端 detail / axios message，并在可用时拼接 request_id），减少“信息不一致/难排障”。
  - E2E：新增统一的 `tests/testBase.js`，默认拦截并 mock `/api/**`，让 Playwright 在“无后端/受限环境”仍可稳定跑 UI 回归；并增强移动端用例的鲁棒性（按钮文案可能出现空格）。
  - 版本号按 SemVer 归类为 Patch：`0.7.2 -> 0.7.3`。
- 核心变更：
  - 前端：`frontend/src/pages/AccessGate.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/pages/DiaryList.jsx`、`frontend/src/pages/PairedIncreaseHistory.jsx`
  - 测试：新增 `frontend/tests/testBase.js`；更新 `frontend/tests/*.spec.js`（统一入口 + 修复移动端跳转路径 + 文案 whitespace 兼容）
  - 版本号：`pyproject.toml`、`frontend/package.json`、`frontend/package-lock.json`、`backend/app/main.py`
- 遗留/约束：
  - `tests/testBase.js` 的 mock 覆盖范围是“最小可用”，后续新增页面/接口的 e2e 用例时，可能需要补齐对应 `/api` 路由 mock。

## [2026-02-08 09:34] - 任务：修复仪表盘 PostgreSQL DISTINCT+ORDER BY 报错并全仓治理
- 原始需求：主页仪表盘报错 `InvalidColumnReferenceError: for SELECT DISTINCT, ORDER BY expressions must appear in select list`，并要求按既定计划实施修复。
- 实现目标/逻辑：
  - 以 `EXISTS` 语义替代 `JOIN + DISTINCT` 去重路径，根治 PostgreSQL 下 `DISTINCT + ORDER BY 表达式` 兼容问题。
  - 修复范围覆盖 `stats` 与 `diaries` 中同类查询，保持 API 入参与响应结构不变。
  - 补充回归测试，重点验证重复配对关系场景下不重复、不报错。
- 核心变更：待更新（`backend/app/api/stats.py`、`backend/app/api/diaries.py`、后端测试文件）。
- 遗留/约束：
  - 不引入数据库迁移；不改变业务口径与接口契约。
  - 验收执行全量后端测试（`uv run pytest`）。

## [2026-02-08 09:39] - 任务：完成 DISTINCT+ORDER BY 兼容修复并验收
- 原始需求：实施“全仓同类排查 + EXISTS 重构”并完成验证。
- 实现目标/逻辑：
  - `stats` 与 `diaries` 中与配对关系相关的查询从 `JOIN + DISTINCT` 改为 `WHERE EXISTS`，避免 PostgreSQL `SELECT DISTINCT` 与表达式排序冲突。
  - 保持接口契约和业务口径不变，重点消除重复关系记录导致的重复行风险。
- 核心变更：
  - 修改 `backend/app/api/stats.py`：新增 `_build_paired_relationship_exists_clause`，重构 `_get_latest_paired_diaries` 与 `get_paired_diaries_increase`。
  - 修改 `backend/app/api/diaries.py`：`scope=matched` 改为 `EXISTS` 过滤；移除 `count(distinct(...))` 与列表 `.distinct()`。
  - 新增 `backend/tests/test_postgres_distinct_orderby_regression.py`：覆盖 SQL 编译回归、重复关系去重回归、接口语义回归。
- 遗留/约束：
  - 当前仓库后端自动化测试主要为本次新增回归集；`unittest discover -s backend` 未发现额外历史测试。

## [2026-02-08 09:45] - 任务：提交并推送 DISTINCT+ORDER BY 修复
- 原始需求：`commit 并推送`。
- 实现目标/逻辑：
  - 将 `stats/diaries` 的 EXISTS 重构和回归测试统一提交到 `main`。
  - 推送到 `origin`（u.pscly.cn）与 `github`（GitHub）两个远端，保证双端同步。
- 核心变更：
  - 已纳入提交文件：`.ai_session.md`、`backend/app/api/stats.py`、`backend/app/api/diaries.py`、`backend/tests/test_postgres_distinct_orderby_regression.py`。
- 遗留/约束：
  - 无数据库迁移；接口契约保持不变。

## [2026-02-11 22:13] - 任务：完善“时间转换”（支持完整日期时间与标题引用简化）
- 原始需求：
  - `> 2026-02-11 21:49:24` 这种也能一键转成 `[21:49:24]`
  - `## ((20260211214940-o4z438u '内心想法'))` 转成 `## 内心想法`
- 实现目标/逻辑：
  - 在 `convertQuotedTimesToBracket` 里增加两条转换规则（正则 + 计数），保持“一键撤销”机制不变。
  - 规则：
    - `> YYYY-MM-DD HH:MM:SS` / `> YYYY-MM-DDTHH:MM:SS` → 只保留时间部分 `[HH:MM:SS]`
    - 标题行 `## ((<blockId> '标题'))` → `## 标题`（只处理 #~###### 行，避免影响正文引用）
  - 同步更新 UI 文案与 E2E 用例，避免回归。
- 核心变更：
  - 前端：`frontend/src/pages/PublishDiary.jsx`（扩展转换规则 + 提示文案）
  - 测试：`frontend/tests/publish-time-convert.spec.js`（新增完整时间与标题引用断言）
  - 版本号：`0.7.3 -> 0.7.4`（Patch）
- 遗留/约束：
  - 标题简化目前仅识别单引号格式 `((... '标题'))`；若是双引号或更复杂的引用写法，可能需要再扩展。

## [2026-02-18 17:26] - 任务：pairing-partner-last-diary-and-user-credentials（配对对方最后日记 + 用户凭据查看）
- 原始需求：在用户列表/详情页补齐“配对对方最后日记时间”与“用户邮箱/密码查看（默认隐藏可切换）”，并为前端提供必要的后端接口与证据落盘。
- 实现目标/逻辑：
  - `/users` 配对视图：对每条当前配对关系展示“对方最后日记时间/暂无日记”；当对方无日记时返回/展示 `null`（前端呈现为“暂无日记”）。
  - `/user/:id`：展示邮箱/密码信息；密码默认 `******` 打码，按钮 `显示密码/隐藏密码` 控制显隐切换。
  - 后端：新增 `GET /api/users/{user_id}/credentials`；配对相关接口新增 `paired_user_last_diary_time/paired_user_last_diary_source`，降低前端额外请求成本。
  - 验证：为覆盖“对方无日记 -> 返回 null”，额外使用隔离 sqlite DB + 临时 uvicorn 实例做接口验证并落盘证据。
- 核心变更：
  - 后端：`backend/app/api/users.py`（新增 credentials 端点；配对接口补充 `paired_user_last_diary_time/paired_user_last_diary_source`）
  - 前端：`frontend/src/pages/AllUsers.jsx`（配对列表展示对方最后日记时间/暂无日记）、`frontend/src/pages/UserDetail.jsx`（邮箱/密码展示与显隐切换）、`frontend/src/services/api.js`（新增 credentials API 调用）
  - 计划：`.sisyphus/plans/pairing-partner-last-diary-and-user-credentials.md`
  - 证据落盘：`.sisyphus/evidence/`（核心 3 份：`.sisyphus/evidence/api-paired-with-last-diary.json`、`.sisyphus/evidence/ui-users-paired-last-diary.png`、`.sisyphus/evidence/ui-user-detail-password-toggle.png`）
  - 额外验证证据（无日记 -> null）：`.sisyphus/evidence/api-paired-with-last-diary-no-diaries.json`
- 遗留/约束：
  - 会话记录与证据文件中不写入任何敏感信息（不记录邮箱/密码明文、不记录站点门禁口令、不记录 DB 连接串）。
  - `credentials` 属敏感信息接口：前端默认隐藏；后端需持续依赖既有鉴权/门禁策略，避免未授权访问。

## [2026-02-18 18:00] - 任务：/users 配对视图点击“对方最后日记”跳转详情
- 原始需求：在 `/users` 配对视图里，直接点击“对方最后日记”即可打开该日记的详情页。
- 实现目标/逻辑：
  - 后端：在 `GET /api/users/paired/{account_id}` 的元素中新增 `paired_user_last_diary_id`，与 `paired_user_last_diary_time/source` 对应，供前端跳转。
  - 前端：`AllUsers` 将 `paired_user_last_diary_id` 映射为 `pairedUserLastDiaryId`，并让“对方最后日记”Tag 可点击跳转 `/diary/:id`；当无日记时保持不可点击。
- 核心变更：`backend/app/api/users.py`、`frontend/src/pages/AllUsers.jsx`
- 遗留/约束：证据文件仍保留在 `.sisyphus/evidence/` 目录，仅用于本地验收，不纳入提交。

## [2026-02-18 21:09] - 任务：留言数量展示 + 仪表盘今日增量（事件法）
- 原始需求：显示同步接口返回的 `diaries.msg_count`（留言数量）；每个日记在所有出现位置都显示留言数；仪表盘在“配对记录数”后新增面板显示当前留言总数、北京时间今日新增留言及明细（可点击跳转详情）；同一日记发布到多个账号时，留言数按账号隔离。
- 实现目标/逻辑：
  - 数据链路：修正同步 upsert 路径也更新已存在 Diary 的 `msg_count`；当 `msg_count` 增加时写入“增量事件表”（只记录 delta>0，避免重复记数，按账号隔离）。
  - 统计接口：`/stats/overview` 增加 `total_msg_count`（全库 sum）；新增 `/stats/msg-count/increase` 按窗口聚合今日增量 + 返回默认 20 条明细。
  - 前端：在 DiaryList/DiaryDetail/Dashboard/用户页等所有日记条目展示点补充 `留言 {msg_count}` Tag/Badge；Dashboard 新面板展示总量/今日增量/明细，点击明细跳 `/diary/:id`。
  - 测试：Tests-after（前端 Playwright mock + 后端 unittest 最小回归）+ 自动化 QA 场景。
- 核心变更：计划文件 `.sisyphus/plans/msg-count-dashboard-delta.md`；后续将修改 backend collector/stats 与 frontend 多页面渲染点，并新增 msg_count 事件表。
- 遗留/约束：不引入 Alembic；DB 采用启动时 `create_all` 创建新表；今日按 Asia/Shanghai；最终需 `git push`。

## [2026-02-18 22:31] - 任务：扩展 stats overview（全库留言总数）+ 修复 dashboard 列表项 msg_count
- 原始需求：扩展 `/api/stats/overview` 返回 `total_msg_count`（全库 sum），并让 `/api/stats/dashboard` 最近配对记录 items 填充真实 `msg_count`（不再默认 0）。
- 实现目标/逻辑：
  - `total_msg_count` 口径为“全库所有账号所有日记：sum(Diary.msg_count)”，SQL 端用 `coalesce(sum(coalesce(msg_count,0)),0)` 兜底空表/NULL。
  - `latest_paired_diaries.items[*].msg_count` 组装 `DiaryListItemResponse` 时显式传入，避免被 schema 默认值 0 掩盖。
- 核心变更：`backend/app/schemas/stats.py`（`StatsOverviewResponse` 新增必填字段）；`backend/app/api/stats.py`（overview 聚合查询 + latest 列表项显式 msg_count）。
- 遗留/约束：不改动 collector/同步逻辑；不新增 migration；不改动前端。

## [2026-02-18 23:10] - 任务：新增 stats 接口 /stats/msg-count/increase（窗口聚合：增量合计 + 明细）
- 原始需求：新增 `GET /api/stats/msg-count/increase?since_ms=...&until_ms=...&limit=20`，返回窗口内留言数增量合计与按 `(account_id, diary_id)` 聚合的明细，且不跨账号混算，并兼容 SQLite 的 datetime 比较。
- 实现目标/逻辑：
  - 入参：`since_ms` 必填（ge=1）；`until_ms` 可选（ge=1，左闭右开）；`limit` 默认 20（ge=1, le=1000）。响应回显 `limit`，便于前端展示与排障。
  - 时间处理：since_ms/until_ms 转 tz-aware UTC datetime 用于响应；SQLite 下 SQL 比较使用 naive UTC（`dt.replace(tzinfo=None)`），与既有 `/paired-diaries/increase` 口径一致。
  - 聚合：事件表 `DiaryMsgCountEvent` 按 `(account_id, diary_id)` group by，`sum(delta)` 得到该窗口内增量，`max(recorded_at)` 得到 `last_event_at`。
  - 明细字段：通过 join `Diary/Account/User` 一次性拿到 `title/created_date/msg_count/account_email/account_user_name`，避免 N+1。
  - 排序：`delta desc`，其次 `last_event_at desc`；`total_delta` 通过独立聚合按“全窗口”计算，不受 `limit` 影响。
- 核心变更：`backend/app/schemas/stats.py`（新增 `StatsMsgCountIncreaseItem/Response`）；`backend/app/schemas/__init__.py`（导出新 schema）；`backend/app/api/stats.py`（新增路由与聚合查询）。
- 遗留/约束：不改动 collector；不引入 Alembic；接口按 UTC 窗口工作（前端负责以北京时间 00:00 换算 since_ms）。

## [2026-02-19 09:26] - 任务：DiaryDetail 补充账号标识 Tag（防多账号误读）
- 原始需求：在 DiaryDetail 顶部 tags 区与左侧记录列表/抽屉摘要项中，始终展示账号标识 `A{account_id}`；既有“留言 {msg_count}”展示保持不变（继续走 `getShownMsgCount(...)` 兜底）。
- 实现目标/逻辑：
  - 顶部 tags 区新增账号 Tag（`账号 A{diary.account_id}`），确保从“全账号入口”进入详情时也能一眼识别来源账号。
  - 左侧记录列表每条卡片摘要新增账号 Tag（`A{item.account_id}`），避免配对/合并列表下误读。
  - 为 E2E 稳定性补充 `data-testid`：`diary-account-tag` / `diary-list-account-tag`。
- 核心变更：更新 `frontend/src/pages/DiaryDetail.jsx`。
- 遗留/约束：不改动后端接口/数据结构；不引入新依赖；不做 DiaryDetail 大重构。

## [2026-02-19 10:02] - 任务：Tests-after（后端 unittest 最小回归：msg-count/increase 聚合口径）
- 原始需求：新增后端 unittest，覆盖 `backend/app/api/stats.py::get_msg_count_increase` 的核心口径：`total_delta` 不受 limit 影响；items 按 `(account_id, diary_id)` 聚合且不跨账号混算；排序 `delta desc` 同 delta 再按 `last_event_at desc`；limit 截断 items。
- 实现目标/逻辑：
  - 测试 DB：sqlite in-memory async engine + `Base.metadata.create_all()`；用 `patch.object(stats_api, "engine", self.engine)` 让 stats 逻辑走 sqlite 分支。
  - 种子数据：2 个账号 + 至少 2 篇 diary（分属不同账号）+ 至少 3 条事件（其中一篇 diary 2 条事件累计 delta=5，另一篇 1 条事件 delta=1）。
  - 断言：`total_delta == 6`；items 首条为 delta 最大的 (5)；`limit=1` 时 `len(items)==1` 且 `total_delta` 仍为全窗口合计；额外覆盖同 delta 时按 `last_event_at` 排序。
- 核心变更：新增 `backend/tests/test_msg_count_increase.py`。
- 遗留/约束：不改动业务代码；不引入 pytest 等新依赖；测试通过 `uv run python -m unittest discover -s backend/tests -p "test_*.py"`。

## [2026-02-19 10:07] - 任务：集成验收（自动化）+ 提交与推送（msg_count 增量统计全链路）
- 原始需求：完成“同步写入 msg_count 增量事件 + stats 聚合接口 + 前端 Dashboard 面板/详情页账号标识 + 自动化测试”，并执行验收命令后提交、推送；确保 `.sisyphus/**` 不进入 git 历史。
- 实现目标/逻辑：
  - 后端：collector 在 `msg_count` 增加时写入增量事件；stats 提供总量与窗口增量聚合接口，口径按账号隔离。
  - 前端：Dashboard 展示留言总数/今日新增及明细；DiaryDetail 明确展示来源账号标签，避免多账号误读。
  - 测试：后端 unittest 覆盖聚合口径；前端 Playwright 基于 mock 覆盖面板展示与跳转断言。
- 验证：已重跑并通过 `uv run python -m compileall backend/app`、`uv run python -m unittest discover -s backend/tests -p "test_*.py"`、`npm run build`、`npm run test:e2e`。
- 遗留/约束：不引入 Alembic；新表通过 `create_all` 创建；`.sisyphus/**` 仅作为本地编排状态保留。

## [2026-02-20 17:52] - 任务：T10 CI/CD 验证与（可选）增强 GitLab deploy 健康检查
- 原始需求：完成计划 T10：验证本地 `docker compose up -d --build --remove-orphans` 可启动 frontend+backend，并通过前端端口验证 `/` 与 `/api/access/status` 可达；输出命令与结果到 `.sisyphus/evidence/`；必要时增强 `.gitlab-ci.yml` 的 deploy 健康检查。
- 实现目标/逻辑：
  - 端口占用：本机 `31011` 已被占用，遵循“不 kill 未知进程”的约束，改用 `FRONTEND_PORT=31021` 启动 compose。
  - 可达性验证：通过前端端口访问 `/` 与 `/api/access/status`；本机存在代理变量时，`curl` 可能走代理误报 502，因此验证时使用 `curl --noproxy '*'` 强制直连。
  - CI 增强：在 `deploy_u3` job 原有“curl 首页”基础上，追加 1 条对 `/api/access/status` 的 http_code 校验（接受 200/401），用于更早发现“前端可开但后端不可达”的部署问题。
- 核心变更：
  - 证据：新增 `.sisyphus/evidence/task-10-local-compose-deploy.txt`、`.sisyphus/evidence/task-10-api-reachable.txt`
  - CI：更新 `.gitlab-ci.yml`（deploy 增加 1 条 /api 健康检查）
- 遗留/约束：无；本次不做 `git commit/push`，且不修改业务代码。
