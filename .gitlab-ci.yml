stages:
  - deploy

variables:
  # 目标服务器上的部署目录（包含 docker-compose.yml 与 .env）
  DEPLOY_DIR: "/root/mnt2/mydocker2/auto_gitlab/younote"

deploy_u3:
  stage: deploy
  image: docker:27.3.1
  tags:
    # 需要与你在 GitLab Runner 页面给 u3 配置的 tag 一致
    - u3
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  resource_group: "deploy-${CI_PROJECT_PATH_SLUG}"
  environment:
    name: production
  before_script:
    - |
      set -eu
      # 避免 Runner 网络/DNS 抖动导致 apk 拉取 index 失败：同时配置官方源 + 国内镜像，并做重试。
      alpine_ver="v$(cut -d. -f1,2 /etc/alpine-release 2>/dev/null || echo '3.20')"
      cat > /etc/apk/repositories <<EOF
      https://dl-cdn.alpinelinux.org/alpine/${alpine_ver}/main
      https://mirrors.aliyun.com/alpine/${alpine_ver}/main
      https://dl-cdn.alpinelinux.org/alpine/${alpine_ver}/community
      https://mirrors.aliyun.com/alpine/${alpine_ver}/community
      EOF

      ok=""
      for i in 1 2 3 4 5; do
        if apk add --no-cache bash curl rsync docker-cli-compose; then
          ok=1
          break
        fi
        echo "WARNING: apk add 失败（第 ${i} 次），等待重试..." >&2
        sleep "$((i * 2))"
      done
      if [ -z "${ok}" ]; then
        echo "ERROR: apk 依赖安装失败，无法继续部署（请检查 Runner 出站网络/DNS）。" >&2
        exit 1
      fi
  script:
    - |
      set -euo pipefail
      if [ ! -f "${DEPLOY_DIR}/.env" ]; then
        echo "ERROR: ${DEPLOY_DIR}/.env 不存在（已按要求不自动创建/不覆盖）。"
        exit 1
      fi
    - |
      echo "同步代码到部署目录（保留 .env / data / logs）：${DEPLOY_DIR}"
      rsync -a \
        --exclude '.git/' \
        --exclude '.env' \
        --exclude 'data/' \
        --exclude 'logs/' \
        "${CI_PROJECT_DIR}/" "${DEPLOY_DIR}/"
    - |
      echo "构建并启动（docker-compose.yml）"
      docker compose \
        --project-directory "${DEPLOY_DIR}" \
        -f "${DEPLOY_DIR}/docker-compose.yml" \
        up -d --build --remove-orphans
    - |
      echo "健康检查：检测 frontend 端口并访问首页"
      port="$(docker compose --project-directory "${DEPLOY_DIR}" -f "${DEPLOY_DIR}/docker-compose.yml" port frontend 80 | awk -F: 'NR==1{print $NF}' | tail -n 1 || true)"
      if [ -n "${port}" ]; then
        # Runner 环境存在代理变量时，curl 可能走代理误报 502；这里强制直连。
        echo "frontend 映射端口：${port}"

        ok=""
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if curl --noproxy '*' -fsS "http://127.0.0.1:${port}/" >/dev/null; then
            code="$(curl --noproxy '*' -sS -o /dev/null -w '%{http_code}' "http://127.0.0.1:${port}/api/access/status" || true)"
            code="${code:-000}"
            echo "access/status http_code=${code}（尝试 ${i}/10）"
            if [[ "${code}" == "200" || "${code}" == "401" ]]; then
              ok=1
              break
            fi
          else
            echo "WARNING: 首页不可达（尝试 ${i}/10），等待容器就绪..." >&2
          fi

          sleep 2
        done

        if [ -z "${ok}" ]; then
          echo "ERROR: 健康检查失败（frontend port=${port}）。输出容器状态与日志用于排障。" >&2
          docker compose --project-directory "${DEPLOY_DIR}" -f "${DEPLOY_DIR}/docker-compose.yml" ps || true
          docker compose --project-directory "${DEPLOY_DIR}" -f "${DEPLOY_DIR}/docker-compose.yml" logs --tail 200 backend || true
          docker compose --project-directory "${DEPLOY_DIR}" -f "${DEPLOY_DIR}/docker-compose.yml" logs --tail 200 frontend || true
          exit 1
        fi
      else
        echo "WARNING: 未检测到 frontend 端口映射，跳过 curl 检查。"
      fi

redeploy_u3:
  stage: deploy
  image: docker:27.3.1
  tags:
    - u3
  when: manual
  allow_failure: true
  resource_group: "deploy-${CI_PROJECT_PATH_SLUG}"
  before_script:
    - |
      set -eu
      alpine_ver="v$(cut -d. -f1,2 /etc/alpine-release 2>/dev/null || echo '3.20')"
      cat > /etc/apk/repositories <<EOF
      https://dl-cdn.alpinelinux.org/alpine/${alpine_ver}/main
      https://mirrors.aliyun.com/alpine/${alpine_ver}/main
      https://dl-cdn.alpinelinux.org/alpine/${alpine_ver}/community
      https://mirrors.aliyun.com/alpine/${alpine_ver}/community
      EOF

      ok=""
      for i in 1 2 3 4 5; do
        if apk add --no-cache bash docker-cli-compose; then
          ok=1
          break
        fi
        echo "WARNING: apk add 失败（第 ${i} 次），等待重试..." >&2
        sleep "$((i * 2))"
      done
      if [ -z "${ok}" ]; then
        echo "ERROR: apk 依赖安装失败，无法继续 redeploy（请检查 Runner 出站网络/DNS）。" >&2
        exit 1
      fi
  script:
    - |
      set -euo pipefail
      cd "${DEPLOY_DIR}"
      cp -a .env ".env.bak-$(date +%Y%m%d-%H%M%S)"
      docker compose -f docker-compose.yml down --remove-orphans
      docker compose -f docker-compose.yml up -d --build --remove-orphans
