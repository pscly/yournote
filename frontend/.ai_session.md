## [2026-01-22 00:00] - 任务：阅读页列表自动定位 + 访问慢/超时排查
- 原始需求：看记录详情时，左侧/抽屉里的记录列表能自动定位到当前记录位置；并修复访问慢、偶发超时导致前端拿不到数据的问题。
- 实现目标/逻辑：
  - 在 `DiaryDetail` 的列表渲染后，找到“当前记录”条目并触发滚动定位（优先滚到居中），避免每次从顶部开始找。
  - 排查前端“超时”来源（通常是 HTTP 客户端超时或并发请求过多导致后端阻塞），在不改变业务口径的前提下提升稳定性（延长超时、必要的重试/降载）。
- 核心变更：待实现（预计涉及 `frontend/src/pages/DiaryDetail.jsx`、`frontend/src/services/api.js`、必要时 `frontend/src/pages/DiaryList.jsx`）。
- 遗留/约束：
  - Windows + pwsh7 环境；所有新增/修改文件需 UTF-8（无 BOM）。
  - 本仓库存在 `backend/` 与 `frontend/`，按“多子项目隔离”规则，本会话记录放在 `frontend/.ai_session.md`。

## [2026-01-22 00:00] - 进展：已完成滚动定位与超时优化
- 原始需求：同上。
- 实现目标/逻辑：
  - 阅读页：通过 `ref + scrollIntoView` 在列表容器内滚到当前记录，并在已可见时不重复滚动。
  - 访问慢/超时：将 axios 默认超时从 10s 放宽到 30s，并对幂等 GET 做有限次重试（指数退避），降低偶发网络抖动/后端瞬时压力导致的“前端直接超时”。
  - 列表页降载：多账号聚合加载改为“分批并发”（每批 3 个账号）并缓存 `paired` 结果，减少请求洪峰与重复请求；引入请求序号避免并发返回覆盖最新 UI。
- 核心变更：
  - `frontend/src/pages/DiaryDetail.jsx`：新增 `currentDiaryId`、列表容器/当前条目 refs、自动滚动定位逻辑。
  - `frontend/src/services/api.js`：默认超时 30s + GET 自动重试（最多 2 次）。
  - `frontend/src/pages/DiaryList.jsx`：分批加载 + paired 缓存 + loadSeq 防止竞态覆盖。
  - `frontend/eslint.config.js`：补充 Playwright 配置/测试的 Node 全局变量（使 lint 可用）。
- 遗留/约束：
  - `npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），不影响本次功能与构建。

## [2026-01-23 21:11] - 任务：发布记录改为后台执行（非阻塞）
- 原始需求：前端点击“发布记录/发布到所选账号”后应后台发布，不要弹出阻塞弹窗导致只能取消。
- 实现目标/逻辑：
  - 点击发布后直接开始创建 run 并逐账号发布；不再自动弹出 `Modal.confirm`/结果弹窗来阻塞页面。
  - 用非阻塞的 `message` 提示发布开始/结束，并引导用户在“发布历史”里查看明细（需要时再手动打开“发布结果”）。
  - 保留 run 记录与逐账号状态更新逻辑，确保发布过程可追踪。
- 核心变更：预计涉及 `frontend/src/pages/PublishDiary.jsx`（发布按钮逻辑、提示与结果弹窗触发方式）。
- 遗留/约束：Windows + pwsh7；所有新增/修改文件需 UTF-8（无 BOM）；避免重复触发发布。

## [2026-01-23 21:14] - 进展：已改为后台发布不阻塞
- 原始需求：同上。
- 实现目标/逻辑：
  - 发布按钮点击后直接开始发布流程（创建 run + 逐账号发布），不再弹出阻塞式确认弹窗，也不再自动打开“发布结果”弹窗。
  - 用 `message.open({ key })` 显示“发布中/发布完成/发布失败”状态提示，用户可继续操作；需要看明细时在“发布历史”点“查看”。
  - 保留 runDetail 的逐账号状态更新与最终拉取合并逻辑，确保结果与后端落库一致。
- 核心变更：
  - `frontend/src/pages/PublishDiary.jsx`：移除 `Modal.confirm` 与 `setRunModalOpen(true)`，发布改为后台执行并用 message 反馈；发布按钮 `disabled` 增加 `publishing` 防止重复触发。
- 遗留/约束：`npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），不影响本次功能与构建。

## [2026-01-23 21:29] - 任务：后台发布体验与状态隔离优化
- 原始需求：继续验证“后台发布”行为，找出可能的 UX/稳定性问题并做更细致优化。
- 实现目标/逻辑：
  - 状态隔离：将“后台发布中的 run（进度）”与“用户在弹窗里查看的 run（详情）”解耦，避免用户在发布中查看其它 run 时被后台更新污染 UI。
  - 进度可视化：在页面内增加非阻塞的“后台发布进度”提示区，展示完成度与成功/失败统计，并提供手动查看明细入口。
  - 交互细节：发布明细弹窗改为非阻塞（去掉遮罩），并提供手动刷新，方便在发布过程中随时查看最新状态。
- 核心变更：预计仅涉及 `frontend/src/pages/PublishDiary.jsx`（状态拆分 + 进度面板 + 弹窗参数/刷新按钮）。
- 遗留/约束：保持现有后端接口不变；不引入新的阻塞式交互；避免引发编辑器草稿内容被意外覆盖。

## [2026-01-23 21:36] - 进展：已完成状态隔离 + 进度面板 + 非阻塞详情弹窗
- 原始需求：同上。
- 实现目标/逻辑：
  - 将发布流程的状态写入 `activePublishRun`，弹窗查看只读 `runDetail`，两者互不覆盖。
  - 在“编辑/发布”页新增非阻塞的“后台发布进度”面板（可关闭），实时展示完成度与成功/失败/进行中/待发布统计，并提供“查看明细”入口。
  - 发布明细弹窗设置 `mask={false}`，不遮罩页面；并新增“刷新”按钮用于拉取最新详情。
- 核心变更：
  - `frontend/src/pages/PublishDiary.jsx`：新增 `activePublishRun/publishPanelOpen/publishProgress`；发布流程改写为更新 `activePublishRun`；详情弹窗增加 `mask={false}` + `refreshRunDetail` + 刷新按钮；插入进度面板 Card。
- 遗留/约束：`npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），不影响本次功能与构建。

## [2026-01-23 22:04] - 进展：发布改为后端异步执行（刷新不影响）
- 原始需求：用户选择“2）关闭页面/刷新后后台也能继续发布”。
- 实现目标/逻辑：
  - 前端不再逐账号调用 `publish-one`；改为 `createRun` 后调用后端 `startRun`，由后端在后台异步执行整次发布。
  - 前端用轮询 `getRun(runId)` 更新 `activePublishRun`，驱动“后台发布进度”面板实时展示；发布完成后自动提示成功/失败统计。
- 核心变更：
  - `frontend/src/services/api.js`：新增 `publishDiaryAPI.startRun`。
  - `frontend/src/pages/PublishDiary.jsx`：发布流程改为 `createRun + startRun + 轮询`；移除前端并发逐账号发布逻辑；补充移动端状态 Tag 的 `running/unknown` 显示。
- 遗留/约束：
  - 当前后台任务为“进程内异步任务”，后端重启会中断（可通过重新点击发布/后续加恢复机制优化）。

## [2026-01-23 22:09] - 任务：刷新后自动恢复发布进度展示
- 原始需求：在“后台继续发布”的前提下，刷新页面后希望无需手动翻历史，也能立刻看到仍在进行中的发布进度。
- 实现目标/逻辑：
  - 页面加载时扫描最近的发布记录（限制时间窗），若存在未完成的 run，则自动拉取详情并恢复进度面板与轮询。
- 核心变更：预计涉及 `frontend/src/pages/PublishDiary.jsx`（自动检测 + 恢复进度显示）。
- 遗留/约束：为避免误恢复很久以前的“未完成 run”，需要加时间窗/条件过滤。

## [2026-01-23 22:11] - 进展：已支持刷新后自动恢复进度
- 原始需求：同上。
- 实现目标/逻辑：
  - 页面加载时拉取最近 10 条发布记录，筛选“未完成（成功+失败 < 目标账号数）且在 6 小时内”的 run。
  - 自动拉取该 run 详情并恢复进度面板；若检测到 `running` 或者是“刚开始（<60s）”则自动开启轮询，否则提示可能任务已中断（避免无限轮询）。
- 核心变更：
  - `frontend/src/pages/PublishDiary.jsx`：新增自动恢复逻辑（best-effort，不影响正常使用）。

## [2026-01-25 11:21] - 任务：Docker 化前端（Vite build + Nginx 同源代理）
- 原始需求：为项目补齐 Dockerfile + docker-compose；不要引入 PostgreSQL 镜像；让服务器远端可直接部署与更新。
- 实现目标/逻辑：
  - 前端镜像使用多阶段构建：Node 负责 `npm ci && npm run build`，Nginx 负责静态资源托管。
  - 在 Nginx 侧将 `/api`（以及 `/docs`、`/openapi.json` 等）反代到后端容器，保证浏览器同源访问（不依赖跨域 CORS）。
  - SPA 路由支持：`try_files ... /index.html`，避免刷新 404。
- 核心变更：`frontend/Dockerfile`、`frontend/nginx.conf`、`docker-compose.yml`（frontend service 与端口映射）。
- 遗留/约束：如需挂 HTTPS 或对外域名，可在服务器上再加一层反向代理（或扩展 Nginx 配置）。

## [2026-01-25 13:05] - 任务：仪表盘优化（账号列表折叠 + 配对记录增量）
- 原始需求：优化主页：账号列表可折叠；“配对记录数”展示相对昨日 20:00 的增量，并可点击加号查看新增记录。
- 实现目标/逻辑：
  - 账号列表：在仪表盘卡片右上角提供“展开/收起”开关，默认移动端收起，并持久化到本地（避免每次进入都占屏）。
  - 配对记录增量：计算“昨日 20:00（北京时间）”的时间点，从已加载的“配对记录聚合列表”中过滤该时间点之后的记录作为新增，显示 `+N`。
  - 新增记录查看：点击 `+N` 打开抽屉，列表展示新增记录（作者/日期/摘要），点击可直达详情。
- 核心变更：预计修改 `frontend/src/pages/Dashboard.jsx`（折叠状态、增量计算、抽屉列表）。
- 遗留/约束：增量按“已拉取到前端的配对记录” best-effort 统计；如需全量精确统计再考虑增加后端按时间过滤接口。

## [2026-01-25 13:35] - 进展：已完成仪表盘折叠与增量抽屉
- 原始需求：同上。
- 实现目标/逻辑：
  - 账号列表：增加“展开/收起”按钮，并将折叠状态写入 localStorage；默认移动端收起。
  - 配对记录增量：以“昨日 20:00（北京时间）”为起点，筛选 `created_time >= 起点` 的配对记录作为新增，显示 `+N`。
  - 抽屉：点击 `+N` 打开抽屉查看新增记录列表，点击条目直达详情。
- 核心变更：
  - `frontend/src/pages/Dashboard.jsx`：新增折叠状态与本地持久化；新增“昨日 20:00”增量计算；新增 Drawer 展示新增配对记录。
- 遗留/约束：
  - 增量统计依赖仪表盘聚合拉取的“最近配对记录”（每账号最多 100 条），若新增远超该上限可能展示不全（抽屉会提示仅展示部分）。
  - `npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），与本次变更无关。
