## [2026-01-22 00:00] - 任务：阅读页列表自动定位 + 访问慢/超时排查
- 原始需求：看记录详情时，左侧/抽屉里的记录列表能自动定位到当前记录位置；并修复访问慢、偶发超时导致前端拿不到数据的问题。
- 实现目标/逻辑：
  - 在 `DiaryDetail` 的列表渲染后，找到“当前记录”条目并触发滚动定位（优先滚到居中），避免每次从顶部开始找。
  - 排查前端“超时”来源（通常是 HTTP 客户端超时或并发请求过多导致后端阻塞），在不改变业务口径的前提下提升稳定性（延长超时、必要的重试/降载）。
- 核心变更：待实现（预计涉及 `frontend/src/pages/DiaryDetail.jsx`、`frontend/src/services/api.js`、必要时 `frontend/src/pages/DiaryList.jsx`）。
- 遗留/约束：
  - Windows + pwsh7 环境；所有新增/修改文件需 UTF-8（无 BOM）。
  - 本仓库存在 `backend/` 与 `frontend/`，按“多子项目隔离”规则，本会话记录放在 `frontend/.ai_session.md`。

## [2026-01-22 00:00] - 进展：已完成滚动定位与超时优化
- 原始需求：同上。
- 实现目标/逻辑：
  - 阅读页：通过 `ref + scrollIntoView` 在列表容器内滚到当前记录，并在已可见时不重复滚动。
  - 访问慢/超时：将 axios 默认超时从 10s 放宽到 30s，并对幂等 GET 做有限次重试（指数退避），降低偶发网络抖动/后端瞬时压力导致的“前端直接超时”。
  - 列表页降载：多账号聚合加载改为“分批并发”（每批 3 个账号）并缓存 `paired` 结果，减少请求洪峰与重复请求；引入请求序号避免并发返回覆盖最新 UI。
- 核心变更：
  - `frontend/src/pages/DiaryDetail.jsx`：新增 `currentDiaryId`、列表容器/当前条目 refs、自动滚动定位逻辑。
  - `frontend/src/services/api.js`：默认超时 30s + GET 自动重试（最多 2 次）。
  - `frontend/src/pages/DiaryList.jsx`：分批加载 + paired 缓存 + loadSeq 防止竞态覆盖。
  - `frontend/eslint.config.js`：补充 Playwright 配置/测试的 Node 全局变量（使 lint 可用）。
- 遗留/约束：
  - `npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），不影响本次功能与构建。

## [2026-01-23 21:11] - 任务：发布记录改为后台执行（非阻塞）
- 原始需求：前端点击“发布记录/发布到所选账号”后应后台发布，不要弹出阻塞弹窗导致只能取消。
- 实现目标/逻辑：
  - 点击发布后直接开始创建 run 并逐账号发布；不再自动弹出 `Modal.confirm`/结果弹窗来阻塞页面。
  - 用非阻塞的 `message` 提示发布开始/结束，并引导用户在“发布历史”里查看明细（需要时再手动打开“发布结果”）。
  - 保留 run 记录与逐账号状态更新逻辑，确保发布过程可追踪。
- 核心变更：预计涉及 `frontend/src/pages/PublishDiary.jsx`（发布按钮逻辑、提示与结果弹窗触发方式）。
- 遗留/约束：Windows + pwsh7；所有新增/修改文件需 UTF-8（无 BOM）；避免重复触发发布。

## [2026-01-23 21:14] - 进展：已改为后台发布不阻塞
- 原始需求：同上。
- 实现目标/逻辑：
  - 发布按钮点击后直接开始发布流程（创建 run + 逐账号发布），不再弹出阻塞式确认弹窗，也不再自动打开“发布结果”弹窗。
  - 用 `message.open({ key })` 显示“发布中/发布完成/发布失败”状态提示，用户可继续操作；需要看明细时在“发布历史”点“查看”。
  - 保留 runDetail 的逐账号状态更新与最终拉取合并逻辑，确保结果与后端落库一致。
- 核心变更：
  - `frontend/src/pages/PublishDiary.jsx`：移除 `Modal.confirm` 与 `setRunModalOpen(true)`，发布改为后台执行并用 message 反馈；发布按钮 `disabled` 增加 `publishing` 防止重复触发。
- 遗留/约束：`npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），不影响本次功能与构建。

## [2026-01-23 21:29] - 任务：后台发布体验与状态隔离优化
- 原始需求：继续验证“后台发布”行为，找出可能的 UX/稳定性问题并做更细致优化。
- 实现目标/逻辑：
  - 状态隔离：将“后台发布中的 run（进度）”与“用户在弹窗里查看的 run（详情）”解耦，避免用户在发布中查看其它 run 时被后台更新污染 UI。
  - 进度可视化：在页面内增加非阻塞的“后台发布进度”提示区，展示完成度与成功/失败统计，并提供手动查看明细入口。
  - 交互细节：发布明细弹窗改为非阻塞（去掉遮罩），并提供手动刷新，方便在发布过程中随时查看最新状态。
- 核心变更：预计仅涉及 `frontend/src/pages/PublishDiary.jsx`（状态拆分 + 进度面板 + 弹窗参数/刷新按钮）。
- 遗留/约束：保持现有后端接口不变；不引入新的阻塞式交互；避免引发编辑器草稿内容被意外覆盖。

## [2026-01-23 21:36] - 进展：已完成状态隔离 + 进度面板 + 非阻塞详情弹窗
- 原始需求：同上。
- 实现目标/逻辑：
  - 将发布流程的状态写入 `activePublishRun`，弹窗查看只读 `runDetail`，两者互不覆盖。
  - 在“编辑/发布”页新增非阻塞的“后台发布进度”面板（可关闭），实时展示完成度与成功/失败/进行中/待发布统计，并提供“查看明细”入口。
  - 发布明细弹窗设置 `mask={false}`，不遮罩页面；并新增“刷新”按钮用于拉取最新详情。
- 核心变更：
  - `frontend/src/pages/PublishDiary.jsx`：新增 `activePublishRun/publishPanelOpen/publishProgress`；发布流程改写为更新 `activePublishRun`；详情弹窗增加 `mask={false}` + `refreshRunDetail` + 刷新按钮；插入进度面板 Card。
- 遗留/约束：`npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），不影响本次功能与构建。

## [2026-01-23 22:04] - 进展：发布改为后端异步执行（刷新不影响）
- 原始需求：用户选择“2）关闭页面/刷新后后台也能继续发布”。
- 实现目标/逻辑：
  - 前端不再逐账号调用 `publish-one`；改为 `createRun` 后调用后端 `startRun`，由后端在后台异步执行整次发布。
  - 前端用轮询 `getRun(runId)` 更新 `activePublishRun`，驱动“后台发布进度”面板实时展示；发布完成后自动提示成功/失败统计。
- 核心变更：
  - `frontend/src/services/api.js`：新增 `publishDiaryAPI.startRun`。
  - `frontend/src/pages/PublishDiary.jsx`：发布流程改为 `createRun + startRun + 轮询`；移除前端并发逐账号发布逻辑；补充移动端状态 Tag 的 `running/unknown` 显示。
- 遗留/约束：
  - 当前后台任务为“进程内异步任务”，后端重启会中断（可通过重新点击发布/后续加恢复机制优化）。

## [2026-01-23 22:09] - 任务：刷新后自动恢复发布进度展示
- 原始需求：在“后台继续发布”的前提下，刷新页面后希望无需手动翻历史，也能立刻看到仍在进行中的发布进度。
- 实现目标/逻辑：
  - 页面加载时扫描最近的发布记录（限制时间窗），若存在未完成的 run，则自动拉取详情并恢复进度面板与轮询。
- 核心变更：预计涉及 `frontend/src/pages/PublishDiary.jsx`（自动检测 + 恢复进度显示）。
- 遗留/约束：为避免误恢复很久以前的“未完成 run”，需要加时间窗/条件过滤。

## [2026-01-23 22:11] - 进展：已支持刷新后自动恢复进度
- 原始需求：同上。
- 实现目标/逻辑：
  - 页面加载时拉取最近 10 条发布记录，筛选“未完成（成功+失败 < 目标账号数）且在 6 小时内”的 run。
  - 自动拉取该 run 详情并恢复进度面板；若检测到 `running` 或者是“刚开始（<60s）”则自动开启轮询，否则提示可能任务已中断（避免无限轮询）。
- 核心变更：
  - `frontend/src/pages/PublishDiary.jsx`：新增自动恢复逻辑（best-effort，不影响正常使用）。

## [2026-01-25 11:21] - 任务：Docker 化前端（Vite build + Nginx 同源代理）
- 原始需求：为项目补齐 Dockerfile + docker-compose；不要引入 PostgreSQL 镜像；让服务器远端可直接部署与更新。
- 实现目标/逻辑：
  - 前端镜像使用多阶段构建：Node 负责 `npm ci && npm run build`，Nginx 负责静态资源托管。
  - 在 Nginx 侧将 `/api`（以及 `/docs`、`/openapi.json` 等）反代到后端容器，保证浏览器同源访问（不依赖跨域 CORS）。
  - SPA 路由支持：`try_files ... /index.html`，避免刷新 404。
- 核心变更：`frontend/Dockerfile`、`frontend/nginx.conf`、`docker-compose.yml`（frontend service 与端口映射）。
- 遗留/约束：如需挂 HTTPS 或对外域名，可在服务器上再加一层反向代理（或扩展 Nginx 配置）。

## [2026-01-25 13:05] - 任务：仪表盘优化（账号列表折叠 + 配对记录增量）
- 原始需求：优化主页：账号列表可折叠；“配对记录数”展示相对昨日 20:00 的增量，并可点击加号查看新增记录。
- 实现目标/逻辑：
  - 账号列表：在仪表盘卡片右上角提供“展开/收起”开关，默认移动端收起，并持久化到本地（避免每次进入都占屏）。
  - 配对记录增量：计算“昨日 20:00（北京时间）”的时间点，从已加载的“配对记录聚合列表”中过滤该时间点之后的记录作为新增，显示 `+N`。
  - 新增记录查看：点击 `+N` 打开抽屉，列表展示新增记录（作者/日期/摘要），点击可直达详情。
- 核心变更：预计修改 `frontend/src/pages/Dashboard.jsx`（折叠状态、增量计算、抽屉列表）。
- 遗留/约束：增量按“已拉取到前端的配对记录” best-effort 统计；如需全量精确统计再考虑增加后端按时间过滤接口。

## [2026-01-25 13:35] - 进展：已完成仪表盘折叠与增量抽屉
- 原始需求：同上。
- 实现目标/逻辑：
  - 账号列表：增加“展开/收起”按钮，并将折叠状态写入 localStorage；默认移动端收起。
  - 配对记录增量：以“昨日 20:00（北京时间）”为起点，筛选 `created_time >= 起点` 的配对记录作为新增，显示 `+N`。
  - 抽屉：点击 `+N` 打开抽屉查看新增记录列表，点击条目直达详情。
- 核心变更：
  - `frontend/src/pages/Dashboard.jsx`：新增折叠状态与本地持久化；新增“昨日 20:00”增量计算；新增 Drawer 展示新增配对记录。
- 遗留/约束：
  - 增量统计依赖仪表盘聚合拉取的“最近配对记录”（每账号最多 100 条），若新增远超该上限可能展示不全（抽屉会提示仅展示部分）。
  - `npm -C frontend run lint` 仍有 1 条既有 warning（`SyncMonitor.jsx` 的 hooks 依赖），与本次变更无关。

## [2026-02-05 11:20] - 任务：新增配对记录历史页（按天）+ 详情页附件底部汇总
- 原始需求：
  - 在“新增配对记录”入口中能查看历史新增（昨天/前天/某天）。
  - 记录详情页末尾展示所有附件，并明确每张图片是“图几（图N）”。
- 实现目标/逻辑：
  - 新增独立页面 `/paired-increase-history`：按北京时间选日期，调用后端区间统计接口，展示当日新增配对记录明细并可跳转详情。
  - 仪表盘抽屉新增“查看历史（按天）”入口，保持现有“窗口增量”快速查看能力。
  - 详情页附件区移动到最底部：每张缩略图展示 `图N`，无附件时给出空状态。
- 核心变更（计划）：
  - 新增 `frontend/src/pages/PairedIncreaseHistory.jsx`
  - 更新 `frontend/src/App.jsx`、`frontend/src/pages/Dashboard.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/utils/time.js`
  - 补充 Playwright e2e（历史页可见性、附件图号与位置）
- 遗留/约束：不引入额外日期库依赖（使用 antd DatePicker 的 dateString 与本地工具函数完成时区换算）。

## [2026-02-08 01:22] - 任务：继续打磨（错误提示一致性 + E2E Mock 基座）
- 原始需求：持续打磨产品体验与稳定性，并把改动推送。
- 实现目标/逻辑：
  - 错误提示：页面 toast/错误文案统一走 `getErrorMessage`，让用户看到更一致、更可排障的错误信息（含 request_id）。
  - Playwright：抽出 `tests/testBase.js` 作为统一入口，默认 mock `/api/**`，使 E2E 更稳定、更不依赖后端；并修复移动端用例在“阅读模式/按钮文案空格”场景下的脆弱性。
- 核心变更：
  - `frontend/src/pages/AccessGate.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/pages/DiaryList.jsx`、`frontend/src/pages/PairedIncreaseHistory.jsx`
  - `frontend/tests/testBase.js`、`frontend/tests/*.spec.js`
- 遗留/约束：mock 覆盖范围按“最小可用”维护；新增用例时补齐对应接口即可。

## [2026-02-18 12:15] - 任务：/users 配对视图展示对方最后日记时间
- 原始需求：在 `/users` 的“配对视图 / 当前配对关系”列表中，展示 `pairedUser` 的最后日记时间（无日记则显示“暂无日记”）。
- 实现目标/逻辑：
  - 构建 `nextActivePairs` 时读取后端字段 `paired_user_last_diary_time`（snake_case），映射到前端 UI 字段 `pairedUserLastDiaryTime`。
  - 列表项中新增 Tag：`对方最后日记 <time|暂无日记>`；时间使用既有 `formatShortTime`，空值兜底为“暂无日记”。
- 核心变更：
  - `frontend/src/pages/AllUsers.jsx`：`nextActivePairs` 增加 `pairedUserLastDiaryTime`；“当前配对关系”列表项新增“对方最后日记”标签；同时修复 hooks 依赖提示（`loadData` 改为 `useCallback` 并补齐 effect deps）。
- 遗留/约束：保持“全部用户”页签布局不变；不引入新依赖。

## [2026-02-18 12:38] - 任务：/user/:id 展示邮箱/密码（遮罩 + 点击显示）
- 原始需求：在用户详情页补充账号凭据展示：邮箱/密码（默认遮罩，按钮切换明文/遮罩），且 credentials 请求失败/404 不影响整页。
- 实现目标/逻辑：
  - 新增 `userAPI.credentials(id)` 调用 `GET /users/${id}/credentials`。
  - `UserDetail` 维持既有“用户信息 + 记录列表”加载逻辑不变；额外独立拉取 credentials，失败时兜底为“无账号凭据”（仅影响邮箱/密码两项）。
  - 密码展示规则：
    - `has_account=false`：展示 `无账号凭据`
    - `has_account=true` 且 `password` 为空：展示 `-`（不出现切换按钮）
    - `has_account=true` 且 `password` 非空：默认 `******`，按钮固定文案 `显示密码/隐藏密码` 切换；并在切换用户 id 时重置 `showPassword=false`。
- 核心变更：
  - `frontend/src/services/api.js`：新增 `userAPI.credentials`。
  - `frontend/src/pages/UserDetail.jsx`：新增 credentials 独立拉取与“邮箱/密码”展示（遮罩 + 点击显示/隐藏）。
- 遗留/约束：不引入新依赖；不将密码写入 console/toast/tooltip。

## [2026-02-18 18:00] - 任务：/users 点击“对方最后日记”跳转详情
- 原始需求：在 `/users` → “配对视图” → “当前配对关系”列表中，点击“对方最后日记”即可打开该日记详情。
- 实现目标/逻辑：
  - `AllUsers` 从后端字段 `paired_user_last_diary_id` 映射为 `pairedUserLastDiaryId`。
  - “对方最后日记”Tag 在存在 diaryId 时可点击，跳转到 `/diary/:id`；无日记时仍显示“暂无日记”但不跳转。
- 核心变更：`frontend/src/pages/AllUsers.jsx`
- 遗留/约束：保持原有布局与时间格式化逻辑不变。

## [2026-02-19 00:00] - 任务：Tests-after（Playwright mock + E2E 覆盖 msg_count）
- 原始需求：更新 Playwright mock，并新增/更新 E2E 用例覆盖 msg_count 面板展示、明细点击跳转、详情页账号标签。
- 实现目标/逻辑：
  - mock 层补齐 `msg_count/total_msg_count`，并新增 `GET /api/stats/msg-count/increase`，避免未匹配 /api 请求落入 204 造成用例不稳定。
  - E2E 用稳定选择器断言：Dashboard 面板 + top item 点击跳转 /diary/1，DiaryDetail 顶部账号 Tag 文案包含 `账号 A1`。
- 核心变更：`frontend/tests/testBase.js`、`frontend/tests/msg-count.spec.js`。
- 遗留/约束：不改动生产代码；不新增依赖；以 mock API 为默认 e2e 数据源。

## [2026-02-19 10:07] - 任务：留言数面板（Dashboard）+ 详情页账号标识（DiaryDetail）+ E2E 回归
- 原始需求：仪表盘新增留言统计面板（总量/今日新增/明细可跳转）；详情页在 tags 与列表摘要中始终展示账号标识（`A{account_id}`）；并补齐 Playwright mock/spec 保障稳定回归。
- 实现目标/逻辑：
  - Dashboard：展示 `total_msg_count` 与“北京时间今日新增留言（窗口聚合）”并列出 top 明细；点击明细跳转到对应详情。
  - DiaryDetail：顶部 tags 与列表项摘要补充账号 Tag，并为 E2E 增加稳定选择器（`data-testid`）。
  - 测试：`tests/testBase.js` mock 覆盖新增 stats 路由与字段；新增 `tests/msg-count.spec.js` 覆盖面板展示与跳转。
- 核心变更：`frontend/src/pages/Dashboard.jsx`、`frontend/src/pages/DiaryDetail.jsx`、`frontend/src/services/api.js`、`frontend/tests/testBase.js`、`frontend/tests/msg-count.spec.js`。
- 遗留/约束：mock API 覆盖范围按“最小可用”维护；新增用例时需要同步补齐对应 mock。

## [2026-02-19 21:20] - 任务：用户详情页“被配对记录”展示主账号邮箱 + 可点击跳转
- 原始需求：在用户详情页里，被配对用户的配对信息区域展示“主账号的邮箱”，并且点击该邮箱能直接打开主账号的用户详情。
- 实现目标/逻辑：
  - 复用 `UserDetail` 里现有的 `accountAPI.list() + userAPI.paired(accountId)` 聚合逻辑，不新增后端接口。
  - 在匹配到当前用户的配对记录时，将 `accounts` 列表里的 `email` 带入 `pairedRecord`（作为“主账号邮箱”展示来源）。
  - UI 侧在“被配对记录”中新增一项“主账号邮箱”，并提供点击后 `navigate('/user/:id')` 的站内跳转；同时主账号 Tag 也支持点击跳转。
- 核心变更：
  - `frontend/src/pages/UserDetail.jsx`：`pairedRecord` 增加 `accountEmail`；“被配对记录”新增“主账号邮箱”展示与跳转。
- 遗留/约束：无；`npm -C frontend run build` 仅有 bundle size warning（既有问题）。
